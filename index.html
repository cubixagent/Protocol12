<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Execution Engine — Tactical Advisor Edition</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00ff88">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
:root {
  --bg: #0a0a0a;
  --bg1: #111111;
  --bg2: #181818;
  --bg3: #1f1f1f;
  --border: #2a2a2a;
  --border2: #333333;
  --accent: #00ff88;
  --accent2: #00cc6a;
  --accent3: rgba(0,255,136,0.12);
  --accent4: rgba(0,255,136,0.04);
  --text: #e8e8e8;
  --text2: #999;
  --text3: #555;
  --danger: #ff3b3b;
  --warn: #ffaa00;
  --info: #00aaff;
  --success: #00ff88;
  --font-mono: 'Courier New', Courier, monospace;
  --font: -apple-system, 'SF Pro Display', 'Segoe UI', sans-serif;
  --radius: 4px;
  --radius2: 8px;
  --transition: 0.2s ease;
  --glow: 0 0 20px rgba(0,255,136,0.25);
  --glow-sm: 0 0 8px rgba(0,255,136,0.3);
}
.theme-midnight {
  --accent: #4488ff;
  --accent2: #2266dd;
  --accent3: rgba(68,136,255,0.12);
  --accent4: rgba(68,136,255,0.04);
  --glow: 0 0 20px rgba(68,136,255,0.25);
  --glow-sm: 0 0 8px rgba(68,136,255,0.3);
}
.theme-graphite {
  --bg: #0c0c0e;
  --bg1: #13131a;
  --bg2: #1a1a24;
  --bg3: #22222e;
  --border: #2a2a3a;
  --border2: #35354a;
  --accent: #00ddcc;
  --accent2: #00aa99;
  --accent3: rgba(0,221,204,0.12);
  --accent4: rgba(0,221,204,0.04);
  --glow: 0 0 20px rgba(0,221,204,0.25);
  --glow-sm: 0 0 8px rgba(0,221,204,0.3);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 14px; scroll-behavior: smooth; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  min-height: 100vh;
  overflow-x: hidden;
  line-height: 1.5;
}
body.command-mode { box-shadow: inset 0 0 0 3px var(--danger); animation: commandPulse 2s ease-in-out infinite; }
@keyframes commandPulse { 0%,100%{box-shadow:inset 0 0 0 3px var(--danger)} 50%{box-shadow:inset 0 0 0 3px #ff7777,0 0 40px rgba(255,59,59,0.3)} }
@keyframes performanceGlow { 0%{box-shadow:none} 50%{box-shadow:inset 0 0 0 2px var(--accent),0 0 50px var(--accent3)} 100%{box-shadow:none} }
body.performance-glow { animation: performanceGlow 2s ease; }
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent); }

#commandBanner { display: none; background: linear-gradient(90deg,#ff1a1a11,#ff3b3b22,#ff1a1a11); border-bottom: 1px solid var(--danger); color: var(--danger); text-align: center; padding: 8px 20px; font-family: var(--font-mono); font-size: 11px; letter-spacing: 2px; text-transform: uppercase; animation: bannerBlink 3s ease-in-out infinite; }
@keyframes bannerBlink { 0%,100%{opacity:1} 50%{opacity:0.6} }
#commandBanner.active { display: block; }
#backupBanner { display: none; background: rgba(255,170,0,0.08); border-bottom: 1px solid rgba(255,170,0,0.3); color: var(--warn); text-align: center; padding: 6px 20px; font-size: 11px; letter-spacing: 1px; }
#backupBanner.active { display: flex; align-items: center; justify-content: center; gap: 12px; }

#appHeader { position: sticky; top: 0; z-index: 100; background: rgba(10,10,10,0.97); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); padding: 0 24px; display: flex; align-items: center; justify-content: space-between; height: 56px; }
.header-brand { display: flex; flex-direction: column; gap: 1px; }
.brand-name { font-family: var(--font-mono); font-size: 13px; color: var(--accent); letter-spacing: 3px; text-transform: uppercase; font-weight: bold; }
.brand-sub { font-size: 9px; color: var(--text3); letter-spacing: 2px; text-transform: uppercase; }
.header-mission { display: flex; align-items: center; gap: 20px; }
#missionCountdown { font-family: var(--font-mono); font-size: 11px; padding: 5px 14px; border: 1px solid currentColor; border-radius: var(--radius); letter-spacing: 1px; transition: all 0.3s; }
#missionCountdown.tpi-green { color: var(--success); border-color: rgba(0,255,136,0.4); background: rgba(0,255,136,0.05); }
#missionCountdown.tpi-yellow { color: var(--warn); border-color: rgba(255,170,0,0.4); background: rgba(255,170,0,0.05); }
#missionCountdown.tpi-orange { color: #ff7700; border-color: rgba(255,119,0,0.4); background: rgba(255,119,0,0.05); }
#missionCountdown.tpi-red { color: var(--danger); border-color: rgba(255,59,59,0.4); background: rgba(255,59,59,0.05); }
.header-rank { font-family: var(--font-mono); font-size: 10px; color: var(--text3); letter-spacing: 1px; }
.header-rank span { color: var(--accent); }

#mainNav { display: flex; gap: 0; padding: 0 24px; background: var(--bg1); border-bottom: 1px solid var(--border); overflow-x: auto; }
.nav-btn { background: none; border: none; color: var(--text3); font-size: 11px; font-family: var(--font-mono); letter-spacing: 2px; text-transform: uppercase; padding: 12px 20px; cursor: pointer; border-bottom: 2px solid transparent; transition: all var(--transition); white-space: nowrap; }
.nav-btn:hover { color: var(--text2); }
.nav-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

#appContent { padding: 24px; max-width: 1400px; margin: 0 auto; }
.view { display: none; }
.view.active { display: block; }

.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 16px; }
.grid-5 { display: grid; grid-template-columns: repeat(5,1fr); gap: 16px; }
@media(max-width:900px){ .grid-2,.grid-3,.grid-4,.grid-5{grid-template-columns:1fr 1fr;} }
@media(max-width:600px){ .grid-2,.grid-3,.grid-4,.grid-5{grid-template-columns:1fr;} #appContent{padding:12px;} }

.card { background: var(--bg1); border: 1px solid var(--border); border-radius: var(--radius2); padding: 20px; transition: border-color var(--transition); }
.card:hover { border-color: var(--border2); }
.card-title { font-size: 9px; font-family: var(--font-mono); letter-spacing: 3px; text-transform: uppercase; color: var(--text3); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
.card-title .dot { width: 4px; height: 4px; border-radius: 50%; background: var(--accent); flex-shrink: 0; }
.card-accent { border-color: var(--accent3); }

.metrics-row { display: flex; gap: 16px; flex-wrap: wrap; }
.metric-ring { display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1; min-width: 90px; position: relative; }
.ring-svg { width: 80px; height: 80px; }
.ring-track { fill: none; stroke: var(--bg3); stroke-width: 6; }
.ring-fill { fill: none; stroke: var(--accent); stroke-width: 6; stroke-linecap: round; transition: stroke-dashoffset 0.6s ease; transform-origin: center; transform: rotate(-90deg); }
.ring-val { position: absolute; top: 24px; left: 50%; transform: translateX(-50%); font-family: var(--font-mono); font-size: 16px; font-weight: bold; color: var(--accent); }
.ring-label { font-size: 9px; color: var(--text3); letter-spacing: 2px; text-transform: uppercase; text-align: center; }
.ring-tooltip { position: relative; }
.ring-tooltip:hover .tooltip-text { opacity: 1; pointer-events: auto; }
.tooltip-text { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--bg3); border: 1px solid var(--border2); color: var(--text2); font-size: 10px; padding: 6px 10px; border-radius: var(--radius); white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity var(--transition); z-index: 50; }

.fatigue-bar-wrap { margin-top: 8px; }
.fatigue-label-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 10px; color: var(--text3); }
.fatigue-bar-track { height: 8px; background: var(--bg3); border-radius: 4px; overflow: hidden; }
.fatigue-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease, background-color 0.3s; }

.btn { background: none; border: 1px solid var(--border2); color: var(--text2); padding: 7px 16px; border-radius: var(--radius); font-size: 11px; font-family: var(--font-mono); letter-spacing: 1px; cursor: pointer; transition: all var(--transition); text-transform: uppercase; }
.btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent4); }
.btn-primary { background: var(--accent); color: #000; border-color: var(--accent); font-weight: bold; }
.btn-primary:hover { background: var(--accent2); border-color: var(--accent2); color: #000; box-shadow: var(--glow-sm); }
.btn-danger { border-color: rgba(255,59,59,0.4); color: var(--danger); }
.btn-danger:hover { background: rgba(255,59,59,0.1); border-color: var(--danger); }
.btn-sm { padding: 4px 10px; font-size: 10px; }
.btn-active { border-color: var(--accent); color: var(--accent); background: var(--accent4); }

.input-group { margin-bottom: 14px; }
.input-label { font-size: 9px; color: var(--text3); letter-spacing: 2px; text-transform: uppercase; display: block; margin-bottom: 5px; }
input, select, textarea { width: 100%; background: var(--bg2); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: var(--radius); font-size: 12px; font-family: var(--font); transition: border-color var(--transition); outline: none; }
input:focus, select:focus, textarea:focus { border-color: var(--accent); }
select option { background: var(--bg2); color: var(--text); }
textarea { resize: vertical; min-height: 80px; line-height: 1.6; }

.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
.modal-overlay.active { display: flex; }
.modal { background: var(--bg1); border: 1px solid var(--border2); border-radius: var(--radius2); padding: 28px; max-width: 480px; width: 100%; max-height: 90vh; overflow-y: auto; animation: modalIn 0.2s ease; }
@keyframes modalIn { from{opacity:0;transform:scale(0.95)} to{opacity:1;transform:scale(1)} }
.modal-title { font-family: var(--font-mono); font-size: 11px; letter-spacing: 3px; text-transform: uppercase; color: var(--accent); margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
.modal-close { background: none; border: none; color: var(--text3); cursor: pointer; font-size: 18px; transition: color var(--transition); }
.modal-close:hover { color: var(--text); }

.block-card { background: var(--bg2); border: 1px solid var(--border); border-left: 3px solid var(--accent); border-radius: var(--radius); padding: 14px; margin-bottom: 10px; transition: all var(--transition); cursor: grab; }
.block-card:active { cursor: grabbing; opacity: 0.8; }
.block-card.completed { border-left-color: var(--text3); opacity: 0.6; }
.block-card.running { border-left-color: var(--success); box-shadow: 0 0 10px rgba(0,255,136,0.15); }
.block-card.paused { border-left-color: var(--warn); }
.block-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.block-subject { font-size: 13px; font-weight: 600; color: var(--text); }
.block-meta { font-size: 10px; color: var(--text3); font-family: var(--font-mono); display: flex; gap: 12px; margin-bottom: 10px; flex-wrap: wrap; }
.block-timer { font-family: var(--font-mono); font-size: 20px; color: var(--accent); text-align: center; padding: 6px 0; letter-spacing: 2px; }
.block-controls { display: flex; gap: 6px; flex-wrap: wrap; }
.block-progress { height: 3px; background: var(--bg3); border-radius: 2px; margin-top: 8px; overflow: hidden; }
.block-progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; }
.status-badge { font-size: 9px; font-family: var(--font-mono); padding: 2px 7px; border-radius: 3px; text-transform: uppercase; letter-spacing: 1px; }
.status-badge.idle { background: var(--bg3); color: var(--text3); }
.status-badge.running { background: rgba(0,255,136,0.15); color: var(--success); }
.status-badge.paused { background: rgba(255,170,0,0.15); color: var(--warn); }
.status-badge.done { background: rgba(100,100,100,0.2); color: var(--text3); }

/* TEST LOG inline in block */
.test-log-row { display: flex; align-items: center; gap: 8px; margin-top: 8px; border-top: 1px solid var(--border); padding-top: 8px; }
.test-log-label { font-size: 10px; color: var(--text3); font-family: var(--font-mono); white-space: nowrap; }
.test-log-input { width: 70px; padding: 4px 8px; font-size: 11px; }
.test-efficiency-badge { font-family: var(--font-mono); font-size: 10px; padding: 2px 8px; background: var(--bg3); border-radius: 3px; color: var(--accent); }

/* CALENDAR */
.cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
.cal-title { font-family: var(--font-mono); font-size: 13px; color: var(--accent); }
.cal-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 2px; }
.cal-dayname { text-align: center; font-size: 9px; color: var(--text3); letter-spacing: 1px; padding: 8px 0; text-transform: uppercase; }
.cal-cell { min-height: 70px; background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius); padding: 6px; cursor: pointer; transition: all var(--transition); overflow: hidden; }
.cal-cell:hover { border-color: var(--accent3); background: var(--bg3); }
.cal-cell.today { border-color: var(--accent); }
.cal-cell.other-month { opacity: 0.35; }
.cal-date { font-size: 11px; color: var(--text3); font-family: var(--font-mono); margin-bottom: 3px; }
.cal-cell.today .cal-date { color: var(--accent); }
.cal-block-dot { font-size: 9px; color: var(--accent); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.cal-exec-bar { height: 2px; background: var(--bg3); border-radius: 1px; margin-top: 3px; overflow: hidden; }
.cal-exec-fill { height: 100%; border-radius: 1px; }

.week-grid { display: grid; grid-template-columns: 50px repeat(7,1fr); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
.week-time { background: var(--bg2); border-right: 1px solid var(--border); font-size: 9px; color: var(--text3); font-family: var(--font-mono); text-align: right; padding-right: 6px; line-height: 30px; height: 30px; }
.week-dayhead { background: var(--bg2); border-bottom: 1px solid var(--border); text-align: center; font-size: 10px; padding: 6px; color: var(--text3); }
.week-dayhead.today-col { color: var(--accent); background: var(--accent4); }
.week-cell { height: 30px; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); background: var(--bg1); position: relative; cursor: pointer; transition: background var(--transition); }
.week-cell:hover { background: var(--bg3); }
.week-block-item { position: absolute; left: 1px; right: 1px; background: var(--accent3); border-left: 2px solid var(--accent); border-radius: 2px; font-size: 8px; color: var(--accent); padding: 1px 3px; overflow: hidden; z-index: 5; cursor: pointer; }

.advisor-msg { background: var(--bg2); border: 1px solid var(--border); border-left: 3px solid var(--accent); border-radius: var(--radius); padding: 12px 14px; margin-bottom: 8px; font-size: 12px; color: var(--text2); font-family: var(--font-mono); animation: msgFade 0.3s ease; }
@keyframes msgFade { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:translateY(0)} }
.advisor-msg.critical { border-left-color: var(--danger); }
.advisor-msg.warn { border-left-color: var(--warn); }
.advisor-msg.positive { border-left-color: var(--success); }

.habit-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 8px; }
.habit-name { font-size: 12px; color: var(--text); }
.habit-penalty { font-size: 10px; color: var(--danger); font-family: var(--font-mono); }
.habit-controls { display: flex; gap: 6px; }

.rank-display { text-align: center; padding: 24px; }
.rank-icon { font-size: 48px; margin-bottom: 8px; }
.rank-name { font-family: var(--font-mono); font-size: 20px; color: var(--accent); letter-spacing: 4px; }
.rank-score { font-size: 12px; color: var(--text3); margin-top: 6px; }

.streak-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
.streak-item:last-child { border-bottom: none; }
.streak-val { font-family: var(--font-mono); font-size: 24px; color: var(--accent); }
.streak-label { font-size: 11px; color: var(--text3); letter-spacing: 1px; }

.theme-btn { padding: 8px 14px; border-radius: var(--radius); font-size: 11px; font-family: var(--font-mono); cursor: pointer; border: 1px solid var(--border2); background: none; color: var(--text3); transition: all var(--transition); letter-spacing: 1px; }
.theme-btn:hover,.theme-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent4); }

.tpi-block { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; margin-bottom: 16px; }
.tpi-stat { text-align: center; padding: 14px; background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius); }
.tpi-val { font-family: var(--font-mono); font-size: 22px; font-weight: bold; color: var(--accent); }
.tpi-label { font-size: 9px; color: var(--text3); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }

.exec-score-big { font-family: var(--font-mono); font-size: 48px; font-weight: bold; color: var(--accent); text-align: center; padding: 8px 0; }
.drag-over { border-color: var(--accent) !important; background: var(--accent4) !important; }

.perf-bar-row { display: flex; align-items: flex-end; gap: 3px; height: 60px; margin-top: 8px; }
.perf-bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; }
.perf-bar { width: 100%; background: var(--accent); border-radius: 2px 2px 0 0; min-height: 2px; }
.perf-bar-day { font-size: 8px; color: var(--text3); font-family: var(--font-mono); }

.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.section-title { font-family: var(--font-mono); font-size: 12px; color: var(--text); letter-spacing: 2px; text-transform: uppercase; }
.section-title-accent { color: var(--accent); }
.divider { height: 1px; background: var(--border); margin: 20px 0; }
.mt-8 { margin-top: 8px; }
.mt-12 { margin-top: 12px; }
.mt-16 { margin-top: 16px; }
.mt-20 { margin-top: 20px; }
.text-accent { color: var(--accent); }
.text-muted { color: var(--text3); font-size: 11px; }
.text-danger { color: var(--danger); }
.text-warn { color: var(--warn); }
.font-mono { font-family: var(--font-mono); }
.hidden { display: none !important; }
.confirm-text { font-size: 13px; color: var(--text2); margin-bottom: 20px; }
.confirm-actions { display: flex; gap: 10px; justify-content: flex-end; }

/* ===== REPORT ENGINE STYLES ===== */
.report-filter-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; }
.report-date-range { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.report-date-range input[type=date] { width: auto; }
.report-stat-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  position: relative;
  overflow: hidden;
  transition: all var(--transition);
  animation: statCardIn 0.4s ease both;
}
@keyframes statCardIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.report-stat-card:hover { border-color: var(--border2); }
.report-stat-val { font-family: var(--font-mono); font-size: 26px; font-weight: bold; color: var(--accent); line-height: 1; }
.report-stat-label { font-size: 9px; color: var(--text3); letter-spacing: 2px; text-transform: uppercase; margin-top: 6px; }
.report-compare-arrow { position: absolute; top: 12px; right: 12px; font-size: 18px; }
.report-compare-val { font-size: 10px; color: var(--text3); font-family: var(--font-mono); margin-top: 4px; }
.arrow-up { color: var(--success); }
.arrow-down { color: var(--danger); }
.arrow-neutral { color: var(--text3); }

.mini-canvas-wrap { position: relative; width: 100%; height: 60px; }
.mini-canvas-wrap canvas { width: 100%; height: 60px; display: block; }
.mini-canvas-label { font-size: 9px; color: var(--text3); font-family: var(--font-mono); margin-top: 4px; text-align: center; }

.report-section-title { font-family: var(--font-mono); font-size: 10px; letter-spacing: 3px; color: var(--text3); text-transform: uppercase; margin: 24px 0 12px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }

.human-report {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius2);
  padding: 28px;
  margin-top: 24px;
}
.human-report-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
.human-report-icon { font-size: 24px; }
.human-report-title { font-family: var(--font-mono); font-size: 12px; color: var(--accent); letter-spacing: 3px; text-transform: uppercase; }
.human-report-subtitle { font-size: 10px; color: var(--text3); margin-top: 2px; }
.report-paragraph {
  font-size: 13px;
  color: var(--text2);
  line-height: 1.8;
  margin-bottom: 18px;
  padding: 16px 20px;
  background: var(--bg1);
  border-left: 3px solid var(--border2);
  border-radius: 0 var(--radius) var(--radius) 0;
  transition: border-left-color var(--transition);
}
.report-paragraph.p-summary { border-left-color: var(--accent); }
.report-paragraph.p-comparison { border-left-color: var(--info); }
.report-paragraph.p-assessment { border-left-color: var(--warn); }
.report-paragraph.p-strategy { border-left-color: var(--success); }
.report-paragraph-tag { font-size: 8px; font-family: var(--font-mono); letter-spacing: 2px; text-transform: uppercase; color: var(--text3); display: block; margin-bottom: 8px; }
.report-paragraph em { color: var(--accent); font-style: normal; font-weight: 600; }
.report-paragraph strong { color: var(--text); }

.anomaly-badge { display: inline-block; background: rgba(255,59,59,0.12); border: 1px solid rgba(255,59,59,0.3); color: var(--danger); font-size: 9px; font-family: var(--font-mono); padding: 2px 8px; border-radius: 3px; margin-left: 8px; letter-spacing: 1px; }
.highlight-badge { display: inline-block; background: var(--accent3); border: 1px solid rgba(0,255,136,0.3); color: var(--accent); font-size: 9px; font-family: var(--font-mono); padding: 2px 8px; border-radius: 3px; margin-left: 8px; letter-spacing: 1px; }

.rating-distribution { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
.rating-pill { padding: 4px 12px; border-radius: 12px; font-size: 10px; font-family: var(--font-mono); }
.rating-pill.overloaded { background: rgba(255,59,59,0.12); color: var(--danger); }
.rating-pill.heavy { background: rgba(255,170,0,0.12); color: var(--warn); }
.rating-pill.balanced { background: rgba(0,255,136,0.12); color: var(--success); }
.rating-pill.light { background: rgba(100,100,100,0.15); color: var(--text3); }

.report-empty { text-align: center; padding: 60px 20px; }
.report-empty-icon { font-size: 40px; margin-bottom: 16px; }
.report-empty-title { font-family: var(--font-mono); font-size: 13px; color: var(--text3); letter-spacing: 2px; }
.report-empty-desc { font-size: 12px; color: var(--text3); margin-top: 8px; max-width: 400px; margin-left: auto; margin-right: auto; }

/* Dual metric display */
.dual-metric-row { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; background: var(--border); border-radius: var(--radius); overflow: hidden; margin-top: 8px; }
.dual-metric-cell { background: var(--bg2); padding: 10px 12px; }
.dual-metric-val { font-family: var(--font-mono); font-size: 18px; font-weight: bold; }
.dual-metric-label { font-size: 9px; color: var(--text3); letter-spacing: 1px; text-transform: uppercase; margin-top: 2px; }
.dual-metric-cell.hours .dual-metric-val { color: var(--info); }
.dual-metric-cell.tests .dual-metric-val { color: var(--warn); }

/* Test efficiency */
.efficiency-meter { margin-top: 12px; }
.efficiency-val-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
.efficiency-big { font-family: var(--font-mono); font-size: 28px; color: var(--warn); font-weight: bold; }
.efficiency-label { font-size: 10px; color: var(--text3); margin-top: 4px; }

/* No mission state */
.no-data-inline { padding: 20px; text-align: center; color: var(--text3); font-size: 11px; font-family: var(--font-mono); border: 1px dashed var(--border2); border-radius: var(--radius); }

/* ===== SUBJECT INTELLIGENCE STYLES ===== */
.subject-cat-badge { display:inline-block;font-size:8px;font-family:var(--font-mono);padding:1px 6px;border-radius:2px;letter-spacing:1px;text-transform:uppercase;margin-left:6px;vertical-align:middle;background:var(--accent3);color:var(--accent);border:1px solid rgba(0,255,136,0.2); }
.block-object { font-size:10px;color:var(--text3);font-family:var(--font-mono);margin-top:2px;padding:3px 0;border-top:1px solid var(--border);margin-top:6px;padding-top:6px;direction:rtl;unicode-bidi:bidi-override; }
.block-object.ltr { direction:ltr;unicode-bidi:normal; }

/* Subject Analytics Panel */
.subject-analytics-grid { display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:12px; }
.subj-card { background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--accent);border-radius:var(--radius);padding:12px; }
.subj-card-name { font-size:11px;font-weight:bold;color:var(--text);direction:rtl;unicode-bidi:bidi-override; }
.subj-card-name.ltr { direction:ltr;unicode-bidi:normal; }
.subj-card-stats { display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:8px; }
.subj-stat { text-align:center; }
.subj-stat-val { font-family:var(--font-mono);font-size:15px;color:var(--accent); }
.subj-stat-label { font-size:8px;color:var(--text3);letter-spacing:1px;text-transform:uppercase; }
.subj-dominance-bar { height:3px;background:var(--bg3);border-radius:2px;margin-top:8px;overflow:hidden; }
.subj-dominance-fill { height:100%;background:var(--accent);border-radius:2px; }
.neglected-badge { display:inline-block;background:rgba(255,59,59,0.12);border:1px solid rgba(255,59,59,0.3);color:var(--danger);font-size:8px;font-family:var(--font-mono);padding:1px 6px;border-radius:2px;margin-left:6px; }

/* On-screen Heatmap */
.heatmap-container { overflow-x:auto;margin-top:12px; }
.heatmap-table { border-collapse:collapse;width:100%;min-width:600px; }
.heatmap-table th,.heatmap-table td { border:1px solid var(--border);padding:6px 8px;font-size:10px;font-family:var(--font-mono);text-align:center;white-space:nowrap; }
.heatmap-table th { background:var(--bg3);color:var(--text3);font-size:9px;letter-spacing:1px; }
.heatmap-table td:first-child { background:var(--bg2);color:var(--text3);text-align:left;font-size:9px; }
.heatmap-cell-0 { background:rgba(0,255,136,0.02);color:var(--text3); }
.heatmap-cell-1 { background:rgba(0,255,136,0.08);color:var(--text3); }
.heatmap-cell-2 { background:rgba(0,255,136,0.18);color:var(--text2); }
.heatmap-cell-3 { background:rgba(0,255,136,0.32);color:var(--text); }
.heatmap-cell-4 { background:rgba(0,255,136,0.55);color:#000; }

/* Export buttons row */
.report-export-row { display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px; }

/* ===== JOURNAL EXPORT STYLES ===== */
.jrnl-mode-row { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.jrnl-mode-btn { padding: 8px 20px; border-radius: var(--radius); font-size: 11px; font-family: var(--font-mono); cursor: pointer; border: 1px solid var(--border2); background: none; color: var(--text3); transition: all var(--transition); letter-spacing: 1px; text-transform: uppercase; }
.jrnl-mode-btn:hover { border-color: var(--accent); color: var(--accent); }
.jrnl-mode-btn.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: bold; }
.jrnl-pdf-theme-row { display: flex; gap: 10px; }
.jrnl-pdf-dark { border-color: var(--border2); color: var(--text3); }
.jrnl-pdf-dark.active { background: #1a1a1a; border-color: var(--text2); color: var(--text); }
.jrnl-pdf-light { border-color: var(--border2); color: var(--text3); }
.jrnl-pdf-light.active { background: #f0f0f0; border-color: #999; color: #1a1a1a; }
.jrnl-preview-card { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius2); overflow: hidden; }
.jrnl-preview-header { background: var(--bg3); border-bottom: 1px solid var(--border); padding: 10px 16px; font-family: var(--font-mono); font-size: 9px; letter-spacing: 2px; color: var(--text3); text-transform: uppercase; display: flex; align-items: center; justify-content: space-between; }
.jrnl-page-list { padding: 12px 16px; }
.jrnl-page-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 11px; color: var(--text2); }
.jrnl-page-item:last-child { border-bottom: none; }
.jrnl-page-num { font-family: var(--font-mono); font-size: 10px; color: var(--text3); min-width: 40px; }
.jrnl-page-desc { flex: 1; }
.jrnl-page-blocks { font-family: var(--font-mono); font-size: 10px; color: var(--accent); }
.jrnl-gen-progress { display: none; align-items: center; gap: 12px; padding: 12px 16px; background: var(--accent4); border-top: 1px solid var(--accent3); font-size: 11px; font-family: var(--font-mono); color: var(--accent); }
.jrnl-gen-progress.active { display: flex; }
.jrnl-spinner { width: 14px; height: 14px; border: 2px solid var(--accent3); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }
@keyframes spin { to { transform: rotate(360deg); } }
.jrnl-week-range-label { font-size: 10px; font-family: var(--font-mono); color: var(--accent); margin-top: 8px; min-height: 16px; }
.jrnl-info-row { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 12px; }
.jrnl-info-item { font-size: 10px; color: var(--text3); font-family: var(--font-mono); }
.jrnl-info-item span { color: var(--text2); }
</style>
</head>
<body>

<div id="commandBanner">⚠ COMMAND MODE ACTIVATED — EXECUTION BELOW THRESHOLD FOR 3 CONSECUTIVE DAYS. IMMEDIATE CORRECTIVE ACTION REQUIRED.</div>
<div id="backupBanner"><span>⚠ BACKUP RECOMMENDED — PROTECT YOUR PROGRESS</span><button class="btn btn-sm" onclick="exportBackup()">EXPORT NOW</button></div>

<header id="appHeader">
  <div class="header-brand">
    <div class="brand-name">EXECUTION ENGINE</div>
    <div class="brand-sub">Tactical Advisor Edition · 12 Hour Protocol</div>
  </div>
  <div class="header-mission">
    <div id="missionCountdown" class="tpi-green">NO MISSION SET</div>
    <div class="header-rank">RANK: <span id="headerRank">—</span></div>
  </div>
</header>

<nav id="mainNav">
  <button class="nav-btn active" onclick="switchView('dashboard',this)">DASHBOARD</button>
  <button class="nav-btn" onclick="switchView('blocks',this)">STUDY BLOCKS</button>
  <button class="nav-btn" onclick="switchView('calendar',this)">CALENDAR</button>
  <button class="nav-btn" onclick="switchView('mission',this)">MISSION</button>
  <button class="nav-btn" onclick="switchView('report',this)">REPORT</button>
  <button class="nav-btn" onclick="switchView('advisor',this)">ADVISOR</button>
  <button class="nav-btn" onclick="switchView('habits',this)">HABITS</button>
  <button class="nav-btn" onclick="switchView('journal',this)">JOURNAL PDF</button>
  <button class="nav-btn" onclick="switchView('settings',this)">SETTINGS</button>
</nav>

<main id="appContent">

  <!-- DASHBOARD -->
  <div id="view-dashboard" class="view active">
    <div class="card card-accent" style="margin-bottom:16px">
      <div class="card-title"><span class="dot"></span>PERFORMANCE METRICS</div>
      <div class="metrics-row" id="metricsRow">
        <div class="metric-ring ring-tooltip">
          <svg class="ring-svg" viewBox="0 0 80 80"><circle class="ring-track" cx="40" cy="40" r="32"/><circle class="ring-fill" id="ring-Focus" cx="40" cy="40" r="32" stroke-dasharray="201" stroke-dashoffset="201"/></svg>
          <div class="ring-val" id="val-Focus">50</div>
          <div class="ring-label">Focus</div>
          <div class="tooltip-text">Lost 2pts per interruption. Restored by unbroken deep work sessions.</div>
        </div>
        <div class="metric-ring ring-tooltip">
          <svg class="ring-svg" viewBox="0 0 80 80"><circle class="ring-track" cx="40" cy="40" r="32"/><circle class="ring-fill" id="ring-Discipline" cx="40" cy="40" r="32" stroke-dasharray="201" stroke-dashoffset="201"/></svg>
          <div class="ring-val" id="val-Discipline">50</div>
          <div class="ring-label">Discipline</div>
          <div class="tooltip-text">Penalized by late starts. Rewarded by habit avoidance and on-time execution.</div>
        </div>
        <div class="metric-ring ring-tooltip">
          <svg class="ring-svg" viewBox="0 0 80 80"><circle class="ring-track" cx="40" cy="40" r="32"/><circle class="ring-fill" id="ring-Momentum" cx="40" cy="40" r="32" stroke-dasharray="201" stroke-dashoffset="201"/></svg>
          <div class="ring-val" id="val-Momentum">50</div>
          <div class="ring-label">Momentum</div>
          <div class="tooltip-text">Builds with consecutive high-execution days. Breaks with habits or long delays.</div>
        </div>
        <div class="metric-ring ring-tooltip">
          <svg class="ring-svg" viewBox="0 0 80 80"><circle class="ring-track" cx="40" cy="40" r="32"/><circle class="ring-fill" id="ring-Execution" cx="40" cy="40" r="32" stroke-dasharray="201" stroke-dashoffset="201"/></svg>
          <div class="ring-val" id="val-Execution">0</div>
          <div class="ring-label">Execution</div>
          <div class="tooltip-text">Weighted: Study Hours ×0.4 + Block Completion ×0.2 + Test Volume ×0.4</div>
        </div>
      </div>
    </div>

    <div class="grid-2" style="margin-bottom:16px">
      <div class="card">
        <div class="card-title"><span class="dot"></span>TODAY'S EXECUTION</div>
        <div class="exec-score-big" id="execScoreBig">0%</div>
        <div style="display:flex;gap:16px;justify-content:center;margin-top:8px;flex-wrap:wrap">
          <div style="text-align:center">
            <div class="font-mono" style="font-size:18px;color:var(--info)" id="dash-completed">0h</div>
            <div class="text-muted">STUDY HRS</div>
          </div>
          <div style="text-align:center">
            <div class="font-mono" style="font-size:18px;color:var(--text3)" id="dash-planned">0h</div>
            <div class="text-muted">PLANNED</div>
          </div>
          <div style="text-align:center">
            <div class="font-mono" style="font-size:18px;color:var(--warn)" id="dash-tests">0</div>
            <div class="text-muted">TESTS DONE</div>
          </div>
          <div style="text-align:center">
            <div class="font-mono" style="font-size:18px;color:var(--text3)" id="dash-testsTarget">0</div>
            <div class="text-muted">TARGET TESTS</div>
          </div>
        </div>
        <div class="block-progress" style="margin-top:14px"><div class="block-progress-fill" id="execProgressBar" style="width:0%"></div></div>
        <!-- TEST EFFICIENCY -->
        <div class="efficiency-meter">
          <div class="efficiency-val-row">
            <div>
              <div class="efficiency-big" id="testEfficiencyVal">—</div>
              <div class="efficiency-label">TEST EFFICIENCY (tests/hr)</div>
            </div>
            <div style="text-align:right">
              <div class="font-mono" style="font-size:13px;color:var(--text3)" id="testEfficiencyRating">awaiting data</div>
              <div class="efficiency-label">EFFICIENCY RATING</div>
            </div>
          </div>
          <div class="block-progress"><div class="block-progress-fill" id="testEfficiencyBar" style="width:0%;background:var(--warn)"></div></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title"><span class="dot"></span>FATIGUE INTELLIGENCE</div>
        <div class="fatigue-bar-wrap">
          <div class="fatigue-label-row">
            <span id="fatigueLabel">AWAITING DATA</span>
            <span id="fatigueVal" class="font-mono" style="color:var(--accent)">—</span>
          </div>
          <div class="fatigue-bar-track"><div class="fatigue-bar-fill" id="fatigueBar" style="width:0%"></div></div>
          <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:9px;color:var(--text3)">
            <span>CRITICAL</span><span>BURNOUT</span><span>WARNING</span><span>ELEVATED</span><span>STABLE</span>
          </div>
        </div>
        <div class="text-muted mt-12" id="fatigueAdvice">Log study sessions to enable fatigue monitoring.</div>
        <div class="dual-metric-row mt-12">
          <div class="dual-metric-cell hours">
            <div class="dual-metric-val" id="dash-hoursTotal">0h</div>
            <div class="dual-metric-label">Hours Today</div>
          </div>
          <div class="dual-metric-cell tests">
            <div class="dual-metric-val" id="dash-testsTotal">0</div>
            <div class="dual-metric-label">Tests Today</div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid-3" style="margin-bottom:16px">
      <div class="card">
        <div class="card-title"><span class="dot"></span>STREAKS</div>
        <div class="streak-item">
          <div><div class="streak-val" id="studyStreakVal">0</div><div class="streak-label">STUDY STREAK</div></div>
          <div class="text-muted">≥85% EXEC</div>
        </div>
        <div class="streak-item">
          <div><div class="streak-val" id="deepWorkStreakVal">0</div><div class="streak-label">DEEP WORK</div></div>
          <div class="text-muted">≥4 BLOCKS</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><span class="dot"></span>RANK</div>
        <div class="rank-display" style="padding:8px">
          <div class="rank-icon" id="rankIcon">⚙</div>
          <div class="rank-name" id="rankName">IRON</div>
          <div class="rank-score" id="rankScore">No activity logged yet</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><span class="dot"></span>7-DAY HISTORY</div>
        <div class="perf-bar-row" id="perfBars"><div class="text-muted" style="font-size:10px">No history yet</div></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title"><span class="dot"></span>SESSION SETUP</div>
      <div class="grid-4">
        <div class="input-group">
          <label class="input-label">Planned Hours Today</label>
          <input type="number" id="plannedHoursInput" min="0.5" max="16" step="0.5" placeholder="e.g. 8">
        </div>
        <div class="input-group">
          <label class="input-label">Daily Test Target</label>
          <input type="number" id="dailyTestTarget" min="0" placeholder="e.g. 50">
        </div>
        <div class="input-group">
          <label class="input-label">Weekly Test Target</label>
          <input type="number" id="weeklyTestTarget" min="0" placeholder="e.g. 200">
        </div>
        <div style="display:flex;align-items:flex-end;padding-bottom:14px">
          <button class="btn btn-primary" onclick="savePlannedHours()" style="width:100%">SET TARGETS</button>
        </div>
      </div>
    </div>
  </div>

  <!-- STUDY BLOCKS -->
  <div id="view-blocks" class="view">
    <div class="section-header">
      <div class="section-title">STUDY <span class="section-title-accent">BLOCKS</span></div>
      <button class="btn btn-primary" onclick="openAddBlock()">+ ADD BLOCK</button>
    </div>
    <div id="blocksList"></div>
  </div>

  <!-- CALENDAR -->
  <div id="view-calendar" class="view">
    <div class="section-header">
      <div class="section-title">TACTICAL <span class="section-title-accent">CALENDAR</span></div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-sm" id="calViewMonth" onclick="setCalView('month')">MONTH</button>
        <button class="btn btn-sm" id="calViewWeek" onclick="setCalView('week')">WEEK</button>
        <button class="btn btn-sm" id="calViewDay" onclick="setCalView('day')">DAY</button>
      </div>
    </div>
    <div id="calView-month" class="card">
      <div class="cal-header">
        <button class="btn btn-sm" onclick="calNav(-1)">‹ PREV</button>
        <div class="cal-title" id="calMonthTitle"></div>
        <button class="btn btn-sm" onclick="calNav(1)">NEXT ›</button>
      </div>
      <div class="cal-grid" id="calGrid"></div>
    </div>
    <div id="calView-week" class="hidden card">
      <div class="cal-header">
        <button class="btn btn-sm" onclick="weekNav(-1)">‹ PREV</button>
        <div class="cal-title" id="calWeekTitle"></div>
        <button class="btn btn-sm" onclick="weekNav(1)">NEXT ›</button>
      </div>
      <div class="week-grid" id="weekGrid" style="overflow:auto"></div>
    </div>
    <div id="calView-day" class="hidden">
      <div class="card" style="margin-bottom:16px">
        <div class="cal-header">
          <button class="btn btn-sm" onclick="dayNav(-1)">‹ PREV</button>
          <div class="cal-title" id="calDayTitle"></div>
          <button class="btn btn-sm" onclick="dayNav(1)">NEXT ›</button>
        </div>
      </div>
      <div class="grid-2">
        <div class="card">
          <div class="card-title"><span class="dot"></span>DAILY PANEL</div>
          <div class="tpi-block" id="dayPanelStats"></div>
          <div id="dayTacticalRating" class="advisor-msg positive" style="margin-top:8px"></div>
        </div>
        <div class="card">
          <div class="card-title"><span class="dot"></span>BLOCKS THIS DAY</div>
          <div id="dayBlocksList"></div>
          <button class="btn btn-sm mt-12" onclick="openAddBlockForDate()">+ ADD BLOCK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MISSION -->
  <div id="view-mission" class="view">
    <div class="section-header">
      <div class="section-title">MISSION <span class="section-title-accent">PRESSURE ENGINE</span></div>
    </div>
    <div class="grid-2" style="margin-bottom:16px">
      <div class="card">
        <div class="card-title"><span class="dot"></span>MISSION SETUP</div>
        <div class="input-group">
          <label class="input-label">Mission Name</label>
          <input type="text" id="missionName" placeholder="e.g. Final Exam Preparation">
        </div>
        <div class="input-group">
          <label class="input-label">Target Date</label>
          <input type="date" id="missionDate">
        </div>
        <div class="input-group">
          <label class="input-label">Total Required Hours</label>
          <input type="number" id="missionHours" placeholder="e.g. 500">
        </div>
        <div class="input-group">
          <label class="input-label">Total Required Tests</label>
          <input type="number" id="missionTestsRequired" placeholder="e.g. 2000">
        </div>
        <button class="btn btn-primary" onclick="saveMission()">LOCK IN MISSION</button>
      </div>
      <div class="card card-accent">
        <div class="card-title"><span class="dot"></span>MISSION STATUS</div>
        <div id="missionNoData" class="no-data-inline">No mission configured. Define your objective.</div>
        <div id="missionActivePanel" style="display:none">
          <div class="tpi-block" id="missionStats"></div>
          <div id="tpiMeter" style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;margin-bottom:6px">
              <span class="text-muted">TIME PRESSURE INDEX</span>
              <span class="font-mono" id="tpiVal" style="color:var(--accent)">—</span>
            </div>
            <div class="block-progress"><div class="block-progress-fill" id="tpiBar" style="width:0%"></div></div>
          </div>
          <div class="dual-metric-row mt-12">
            <div class="dual-metric-cell hours">
              <div class="dual-metric-val" id="missionHoursLeft">—</div>
              <div class="dual-metric-label">Hours Remaining</div>
            </div>
            <div class="dual-metric-cell tests">
              <div class="dual-metric-val" id="missionTestsLeft">—</div>
              <div class="dual-metric-label">Tests Remaining</div>
            </div>
          </div>
          <div id="missionAdvisor" class="advisor-msg mt-12" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- REPORT ENGINE -->
  <div id="view-report" class="view">
    <div class="section-header">
      <div class="section-title">PERFORMANCE <span class="section-title-accent">REPORT ENGINE</span></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-primary btn-sm" onclick="generateReport()">GENERATE REPORT</button>
        <button class="btn btn-sm" onclick="exportOperationalDayPDF()">DAY PDF (OPS)</button>
        <button class="btn btn-sm" onclick="exportOperationalWeekPDF()">WEEK PDF (OPS)</button>
        <button class="btn btn-sm" style="border-color:var(--accent);color:var(--accent)" onclick="exportFullAnalyticalPDF()">EXPORT FULL ANALYTICAL PDF</button>
      </div>
    </div>

    <!-- FILTER ROW -->
    <div class="card" style="margin-bottom:16px">
      <div class="card-title"><span class="dot"></span>TIME RANGE SELECTION</div>
      <div class="report-filter-row">
        <button class="btn btn-sm" id="rq-thisweek" onclick="setReportQuick('thisweek')">THIS WEEK</button>
        <button class="btn btn-sm" id="rq-lastweek" onclick="setReportQuick('lastweek')">LAST WEEK</button>
        <button class="btn btn-sm" id="rq-thismonth" onclick="setReportQuick('thismonth')">THIS MONTH</button>
        <button class="btn btn-sm" id="rq-last30" onclick="setReportQuick('last30')">LAST 30 DAYS</button>
        <button class="btn btn-sm" id="rq-custom" onclick="setReportQuick('custom')">CUSTOM</button>
        <div class="report-date-range" id="reportCustomRange" style="display:none">
          <input type="date" id="reportStart" style="width:140px">
          <span style="color:var(--text3);font-size:11px">TO</span>
          <input type="date" id="reportEnd" style="width:140px">
        </div>
      </div>
      <div style="font-size:10px;color:var(--text3);font-family:var(--font-mono)" id="reportRangeLabel">No range selected</div>
    </div>

    <div id="reportOutput">
      <div class="report-empty">
        <div class="report-empty-icon">◈</div>
        <div class="report-empty-title">SELECT A TIME RANGE TO BEGIN ANALYSIS</div>
        <div class="report-empty-desc">The system will generate a full comparative performance analysis including behavioral patterns, trend data, and strategic advice.</div>
      </div>
    </div>
  </div>

  <!-- ADVISOR -->
  <div id="view-advisor" class="view">
    <div class="section-header">
      <div class="section-title">AI <span class="section-title-accent">ADVISORY ENGINE</span></div>
      <button class="btn btn-sm" onclick="generateAdvisory()">REFRESH ANALYSIS</button>
    </div>
    <div id="advisoryList"><div class="no-data-inline">Click REFRESH ANALYSIS to generate insights based on your logged data.</div></div>
  </div>

  <!-- HABITS -->
  <div id="view-habits" class="view">
    <div class="section-header">
      <div class="section-title">HABIT <span class="section-title-accent">TRACKING</span></div>
      <button class="btn btn-primary" onclick="openAddHabit()">+ ADD HABIT</button>
    </div>
    <div id="habitsList"></div>
    <div class="card mt-16">
      <div class="card-title"><span class="dot"></span>TODAY'S HABIT LOG</div>
      <div id="habitDailyLog"></div>
    </div>
  </div>

  <!-- JOURNAL PDF EXPORT -->
  <div id="view-journal" class="view">
    <div class="section-header">
      <div class="section-title">JOURNAL <span class="section-title-accent">PDF EXPORT</span></div>
    </div>

    <div class="grid-2" style="margin-bottom:16px">
      <!-- Left: mode + config -->
      <div>
        <div class="card" style="margin-bottom:16px">
          <div class="card-title"><span class="dot"></span>EXPORT MODE</div>
          <div class="jrnl-mode-row">
            <button class="jrnl-mode-btn active" id="jm-day" onclick="setJournalMode('day')">SINGLE DAY (OPS)</button>
            <button class="jrnl-mode-btn" id="jm-week" onclick="setJournalMode('week')">WEEKLY (OPS · 1 PAGE)</button>
          </div>
          <div id="jrnlDayOpts">
            <div class="input-group" style="margin-bottom:0">
              <label class="input-label">Select Date</label>
              <input type="date" id="jrnlDayDate" onchange="updateJournalPreview()">
            </div>
          </div>
          <div id="jrnlWeekOpts" style="display:none">
            <div class="grid-2" style="gap:12px">
              <div class="input-group" style="margin-bottom:0">
                <label class="input-label">Any Date in the Week</label>
                <input type="date" id="jrnlWeekRefDate" onchange="updateJournalPreview()">
              </div>
              <div class="input-group" style="margin-bottom:0">
                <label class="input-label">Week Starts On</label>
                <select id="jrnlWeekStartDay" onchange="updateJournalPreview()">
                  <option value="0">Sunday</option>
                  <option value="1" selected>Monday</option>
                  <option value="6">Saturday</option>
                </select>
              </div>
            </div>
            <div class="jrnl-week-range-label" id="jrnlWeekRangeLabel">Select a date to compute week range.</div>
          </div>
        </div>
        <div class="card">
          <div class="card-title"><span class="dot"></span>PDF THEME <span style="font-size:8px;color:var(--text3);margin-left:8px">(PDF ONLY — APP THEMES UNCHANGED)</span></div>
          <div class="jrnl-pdf-theme-row">
            <button class="jrnl-mode-btn" id="jpt-dark" onclick="setJournalPdfTheme('dark')">◼ DARK</button>
            <button class="jrnl-mode-btn active" id="jpt-light" onclick="setJournalPdfTheme('light')">◻ LIGHT (PRINT)</button>
          </div>
          <div class="text-muted mt-8" style="line-height:1.7">
            Light: white background, dark text — optimised for printing.<br>
            Dark: #0f0f0f background, accent text — for digital review.
          </div>
          <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-primary" id="jrnlGenerateBtn" onclick="triggerJournalGenerate()">GENERATE OPERATIONAL PDF</button>
            <button class="btn" style="border-color:var(--accent);color:var(--accent)" onclick="exportFullAnalyticalPDF()">EXPORT FULL ANALYTICAL PDF</button>
          </div>
        </div>
      </div>

      <!-- Right: preview + structure -->
      <div>
        <div class="jrnl-preview-card">
          <div class="jrnl-preview-header">
            <span>EXPORT PREVIEW</span>
            <span id="jrnlPageCount" style="color:var(--accent)">—</span>
          </div>
          <div class="jrnl-page-list" id="jrnlPageList">
            <div class="text-muted" style="padding:12px 0;font-size:11px;font-family:var(--font-mono)">Configure options to preview export structure.</div>
          </div>
          <div class="jrnl-gen-progress" id="jrnlProgress">
            <div class="jrnl-spinner"></div>
            <span id="jrnlProgressText">Rendering pages…</span>
          </div>
        </div>
        <div class="card mt-16">
          <div class="card-title"><span class="dot"></span>DOCUMENT STRUCTURE</div>
          <div class="text-muted" style="font-size:11px;line-height:2">
            <strong style="color:var(--accent2)">OPERATIONAL DAILY →</strong> 1 page: summary stats, subject breakdown, compact advisory, structured to-do table (Subject, Object, Duration, Tests, Priority, Status, Notes)<br>
            <strong style="color:var(--accent2)">OPERATIONAL WEEKLY →</strong> 1 single A4 page: weekly summary, 6-8 line executive summary, mini performance chart, <strong>8×9 subject heatmap matrix</strong><br>
            <strong style="color:var(--accent)">FULL ANALYTICAL PDF →</strong> multi-page: all charts, heatmap, full 5-paragraph advisory, subject analytics, comparisons, trends<br>
            <strong style="color:var(--text2)">8×9 MATRIX →</strong> زیست | شیمی | فیزیک | ریاضی | زبان | عربی | فارسی | دینی · hours/tests per day · dynamic color intensity
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="view-settings" class="view">    <div class="section-header">
      <div class="section-title">SYSTEM <span class="section-title-accent">SETTINGS</span></div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="card-title"><span class="dot"></span>THEME</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="theme-btn active" id="theme-obsidian" onclick="setTheme('obsidian')">OBSIDIAN</button>
          <button class="theme-btn" id="theme-midnight" onclick="setTheme('midnight')">MIDNIGHT BLUE</button>
          <button class="theme-btn" id="theme-graphite" onclick="setTheme('graphite')">GRAPHITE</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><span class="dot"></span>BACKUP SYSTEM</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="exportBackup()">EXPORT BACKUP</button>
          <button class="btn" onclick="document.getElementById('importFile').click()">IMPORT BACKUP</button>
          <input type="file" id="importFile" accept=".json" style="display:none" onchange="importBackup(event)">
        </div>
        <div class="text-muted mt-12" id="lastBackupInfo">Last backup: never</div>
      </div>
    </div>
    <div class="card mt-16">
      <div class="card-title"><span class="dot"></span>RESET / DANGER ZONE</div>
      <div style="display:flex;gap:10px">
        <button class="btn btn-danger" onclick="confirmReset()">RESET ALL DATA</button>
      </div>
      <div class="text-muted mt-8">All data will be permanently erased from IndexedDB.</div>
    </div>
  </div>

</main>

<!-- ADD BLOCK MODAL -->
<div class="modal-overlay" id="addBlockModal">
  <div class="modal">
    <div class="modal-title"><span id="blockModalTitle">ADD STUDY BLOCK</span><button class="modal-close" onclick="closeModal('addBlockModal')">×</button></div>
    <input type="hidden" id="editBlockId">
    <div class="input-group">
      <label class="input-label">Subject (زیست، شیمی، Math, Physics…)</label>
      <input type="text" id="blockSubject" placeholder="e.g. ریاضی تجربی / Advanced Physics">
    </div>
    <div class="input-group">
      <label class="input-label">Object / Description (e.g. مشتق ویدئو ۲ — display only, not classified)</label>
      <input type="text" id="blockObject" placeholder="Optional: topic or task description" style="direction:rtl">
    </div>
    <div class="grid-2" style="gap:10px">
      <div class="input-group">
        <label class="input-label">Planned Duration (minutes)</label>
        <input type="number" id="blockDuration" placeholder="90" min="5">
      </div>
      <div class="input-group">
        <label class="input-label">Planned Start Time</label>
        <input type="time" id="blockStartTime">
      </div>
    </div>
    <div class="grid-2" style="gap:10px">
      <div class="input-group">
        <label class="input-label">Target Tests (planned)</label>
        <input type="number" id="blockTests" placeholder="0" min="0">
      </div>
      <div class="input-group">
        <label class="input-label">Completed Tests</label>
        <input type="number" id="blockCompletedTests" placeholder="0" min="0">
      </div>
    </div>
    <div class="input-group">
      <label class="input-label">Date</label>
      <input type="date" id="blockDate">
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:4px" onclick="saveBlock()">SAVE BLOCK</button>
  </div>
</div>

<!-- ADD HABIT MODAL -->
<div class="modal-overlay" id="addHabitModal">
  <div class="modal">
    <div class="modal-title"><span>ADD BAD HABIT</span><button class="modal-close" onclick="closeModal('addHabitModal')">×</button></div>
    <div class="input-group">
      <label class="input-label">Habit Name</label>
      <input type="text" id="habitName" placeholder="e.g. Social Media">
    </div>
    <div class="input-group">
      <label class="input-label">Penalty Value (when performed)</label>
      <input type="number" id="habitPenalty" placeholder="3" min="1" max="10">
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="saveHabit()">SAVE HABIT</button>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal" style="max-width:380px">
    <div class="modal-title"><span id="confirmTitle">CONFIRM</span><button class="modal-close" onclick="closeModal('confirmModal')">×</button></div>
    <div class="confirm-text" id="confirmText"></div>
    <div class="confirm-actions">
      <button class="btn" onclick="closeModal('confirmModal')">CANCEL</button>
      <button class="btn btn-danger" id="confirmOkBtn">CONFIRM</button>
    </div>
  </div>
</div>

<script>
'use strict';
// ================================================================
// SUBJECT INTELLIGENCE — Classification Engine
// Normalizes Persian/English text, detects keywords
// Returns one of 8 matrix categories or 'General'
// Object field is NEVER classified — display only
// ================================================================
const SUBJECT_MATRIX_LABELS = ['زیست','شیمی','فیزیک','ریاضی','زبان','عربی','فارسی','دینی'];
const SUBJECT_RULES = [
  { cat:'زیست',    en:'Biology',     kw:['زیست','biology','biochem','biolog','physiology','anatomy','zoology','botany','microbio','اکولوژی','ژنتیک','genetics','evolution','ecology'] },
  { cat:'شیمی',    en:'Chemistry',   kw:['شیمی','chemi','organic','inorganic','thermochem','electrochemi','polymer','catalyst'] },
  { cat:'فیزیک',   en:'Physics',     kw:['فیزیک','physics','mechanic','wave','optic','electr','thermodynam','quantum','relativity','فیزیک'] },
  { cat:'ریاضی',   en:'Mathematics', kw:['ریاضی','math','algebra','calculus','geometry','statistic','probabilit','linear','integral','derivative','تفاضل','حساب','آمار','احتمال','هندسه','جبر','مشتق','انتگرال','ترکیبیات','combinat','numeric','محاسب'] },
  { cat:'زبان',    en:'Language',    kw:['زبان','english','language','vocab','grammar','reading','listening','writing','toefl','ielts','speaking'] },
  { cat:'عربی',    en:'Arabic',      kw:['عربی','arabic','arab','نحو','صرف','قرائت عربی'] },
  { cat:'فارسی',   en:'Literature',  kw:['فارسی','ادبیات','literature','persian','شعر','نثر','تاریخ ادبیات','آرایه','قرائت فارسی','دستور زبان فارسی'] },
  { cat:'دینی',    en:'Humanities',  kw:['دینی','دین','religion','religious','قرآن','قران','theology','اخلاق','معارف','احکام'] },
];
function classifySubject(text) {
  if (!text) return 'General';
  const low = text.toLowerCase().replace(/[-–—]/g,' ');
  for (const rule of SUBJECT_RULES) {
    for (const kw of rule.kw) {
      if (low.includes(kw)) return rule.cat;
    }
  }
  // Broad English fallbacks
  if (/\b(histo|social|civics|econom|geography|geograph|جغرافیا|تاریخ|اجتماعی|psychology|psycholog)\b/.test(low)) return 'دینی'; // Humanities group
  return 'General';
}
function subjectCatColor(cat) {
  const map = {'زیست':'#00cc6a','شیمی':'#00aaff','فیزیک':'#aa44ff','ریاضی':'#ffaa00','زبان':'#ff6688','عربی':'#ff8844','فارسی':'#44ffcc','دینی':'#88ccff','General':'#666','Biology':'#00cc6a','Chemistry':'#00aaff','Physics':'#aa44ff','Mathematics':'#ffaa00','Language':'#ff6688','Arabic':'#ff8844','Literature':'#44ffcc','Humanities':'#88ccff'};
  return map[cat] || '#666666';
}
function isRTL(text) {
  if (!text) return false;
  return /[\u0600-\u06FF\u0750-\u077F]/.test(text);
}

// ================================================================
// DATABASE
// ================================================================
let db = null;
const DB_NAME = 'ExecutionEngineDB';
const DB_VERSION = 2;

function initDB() {
  return new Promise((res,rej) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      const stores = [
        {name:'dailyLogs',key:{keyPath:'date'}},
        {name:'studyBlocks',key:{autoIncrement:true,keyPath:'id'}},
        {name:'metrics',key:{keyPath:'metricName'}},
        {name:'habits',key:{autoIncrement:true,keyPath:'id'}},
        {name:'streaks',key:{keyPath:'type'}},
        {name:'performanceHistory',key:{autoIncrement:true,keyPath:'id'}},
        {name:'mission',key:{keyPath:'id'}},
        {name:'themes',key:{keyPath:'id'}},
        {name:'interruptions',key:{autoIncrement:true,keyPath:'id'}},
        {name:'fatigueHistory',key:{autoIncrement:true,keyPath:'id'}},
      ];
      stores.forEach(s => { if (!d.objectStoreNames.contains(s.name)) d.createObjectStore(s.name,s.key); });
    };
    req.onsuccess = e => { db = e.target.result; res(db); };
    req.onerror = rej;
  });
}
const tx = (store,mode='readonly') => db.transaction(store,mode).objectStore(store);
function dbGet(store,key) { return new Promise((res,rej) => { const r=tx(store).get(key); r.onsuccess=e=>res(e.target.result); r.onerror=rej; }); }
function dbPut(store,val) { return new Promise((res,rej) => { const r=tx(store,'readwrite').put(val); r.onsuccess=e=>res(e.target.result); r.onerror=rej; }); }
function dbAdd(store,val) { return new Promise((res,rej) => { const r=tx(store,'readwrite').add(val); r.onsuccess=e=>res(e.target.result); r.onerror=rej; }); }
function dbDelete(store,key) { return new Promise((res,rej) => { const r=tx(store,'readwrite').delete(key); r.onsuccess=e=>res(e.target.result); r.onerror=rej; }); }
function dbGetAll(store) { return new Promise((res,rej) => { const r=tx(store).getAll(); r.onsuccess=e=>res(e.target.result); r.onerror=rej; }); }
function dbClear(store) { return new Promise((res,rej) => { const r=tx(store,'readwrite').clear(); r.onsuccess=()=>res(); r.onerror=rej; }); }

// ================================================================
// STATE
// ================================================================
const state = {
  metrics: { Focus:50, Discipline:50, Momentum:50, Execution:0 },
  blocks: [], habits: [], streaks:{study:0,deepWork:0},
  mission: null, theme:'obsidian', todayLog:null, fatigueIndex:null,
  currentView:'dashboard', calDate:new Date(), calView:'month',
  dayView:new Date(), weekOffset:0, runningTimers:{},
  dragBlockId:null, rank:'IRON', lastBackup:null, addingForDate:null,
  reportRange:null, reportQuick:null,
};

// ================================================================
// HELPERS
// ================================================================
const today = () => new Date().toISOString().split('T')[0];
const pad2 = n => String(n).padStart(2,'0');
const fmtTime = s => `${pad2(Math.floor(s/3600))}:${pad2(Math.floor((s%3600)/60))}:${pad2(s%60)}`;
const fmtHr = s => (s/3600).toFixed(2)+'h';
const dayNames = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const addDays = (d,n) => { const r=new Date(d); r.setDate(r.getDate()+n); return r; };
const dateStr = d => d.toISOString().split('T')[0];
const parseDate = s => new Date(s+'T12:00:00');

function el(id) { return document.getElementById(id); }
function setText(id,v) { const e=el(id); if(e) e.textContent=v; }

// ================================================================
// METRICS ENGINE
// ================================================================
async function loadMetrics() {
  const keys = ['Focus','Discipline','Momentum','Execution'];
  for (const k of keys) {
    const r = await dbGet('metrics',k);
    // CLEAN START: default is 50, not 75
    state.metrics[k] = r ? r.value : 50;
  }
}
async function saveMetric(name,value) {
  value = Math.max(0,Math.min(100,Math.round(value)));
  state.metrics[name] = value;
  await dbPut('metrics',{metricName:name,value});
  updateMetricUI(name,value);
}
async function adjustMetric(name,delta) {
  await saveMetric(name, state.metrics[name]+delta);
}
function updateMetricUI(name,value) {
  const ring = el('ring-'+name);
  const v = el('val-'+name);
  if (!ring||!v) return;
  const circ = 2*Math.PI*32;
  ring.style.strokeDashoffset = circ-(value/100)*circ;
  v.textContent = value;
  ring.style.stroke = value>=80?'var(--success)':value>=60?'var(--accent)':value>=40?'var(--warn)':'var(--danger)';
}
function renderAllMetrics() { Object.keys(state.metrics).forEach(k=>updateMetricUI(k,state.metrics[k])); }

// ================================================================
// STUDY BLOCKS ENGINE
// ================================================================
async function loadBlocks() { state.blocks = await dbGetAll('studyBlocks'); }

function openAddBlock() {
  state.addingForDate = null;
  el('editBlockId').value=''; el('blockSubject').value=''; el('blockDuration').value='';
  el('blockStartTime').value=''; el('blockTests').value='0'; el('blockCompletedTests').value='0';
  el('blockDate').value=today(); el('blockModalTitle').textContent='ADD STUDY BLOCK';
  openModal('addBlockModal');
}
function openAddBlockForDate() {
  openAddBlock();
  el('blockDate').value = dateStr(state.dayView);
}
async function saveBlock() {
  const id = el('editBlockId').value;
  const subject = el('blockSubject').value.trim();
  const blockObject = el('blockObject').value.trim();
  const duration = parseInt(el('blockDuration').value)||60;
  const startTime = el('blockStartTime').value;
  const tests = parseInt(el('blockTests').value)||0;
  const completedTests = parseInt(el('blockCompletedTests').value)||0;
  const date = el('blockDate').value||today();
  if (!subject) { showToast('Enter a subject name'); return; }
  const subjectCategory = classifySubject(subject); // classify from subject only, never from object
  const block = {subject,blockObject,subjectCategory,duration,startTime,tests,completedTests,date,status:'idle',elapsed:0,actualStart:null};
  if (id) {
    const ex = state.blocks.find(b=>b.id==id);
    if (ex) { Object.assign(ex,block); ex.id=parseInt(id); await dbPut('studyBlocks',ex); }
  } else {
    block.id = await dbAdd('studyBlocks',block);
    state.blocks.push(block);
  }
  closeModal('addBlockModal');
  renderBlocks();
  renderCalendar();
  await calculateTodayExecution();
}
async function deleteBlock(id) {
  await dbDelete('studyBlocks',id);
  state.blocks = state.blocks.filter(b=>b.id!==id);
  if (state.runningTimers[id]) { clearInterval(state.runningTimers[id].interval); delete state.runningTimers[id]; }
  renderBlocks(); renderCalendar();
  await calculateTodayExecution();
}
function editBlock(id) {
  const b = state.blocks.find(x=>x.id===id);
  if (!b) return;
  el('editBlockId').value=id; el('blockSubject').value=b.subject;
  el('blockObject').value=b.blockObject||'';
  el('blockDuration').value=b.duration;
  el('blockStartTime').value=b.startTime||''; el('blockTests').value=b.tests||0;
  el('blockCompletedTests').value=b.completedTests||0; el('blockDate').value=b.date||today();
  el('blockModalTitle').textContent='EDIT STUDY BLOCK';
  openModal('addBlockModal');
}
async function updateCompletedTests(id,val) {
  const b = state.blocks.find(x=>x.id===id);
  if (!b) return;
  b.completedTests = parseInt(val)||0;
  await dbPut('studyBlocks',b);
  await calculateTodayExecution();
}

// ================================================================
// TIMER ENGINE
// ================================================================
function startBlock(id) {
  const block = state.blocks.find(b=>b.id===id);
  if (!block||block.status==='completed') return;
  if (block.startTime) {
    const now=new Date(), [h,m]=block.startTime.split(':').map(Number);
    const planned=new Date(); planned.setHours(h,m,0,0);
    const diff=(now-planned)/60000;
    if (diff>60) { adjustMetric('Momentum',-3); showToast('Late 60+ min — Momentum -3'); }
    else if (diff>30) { adjustMetric('Discipline',-5); showToast('Late 30+ min — Discipline -5'); }
    else if (diff>15) { adjustMetric('Discipline',-2); showToast('Late 15+ min — Discipline -2'); }
  }
  block.status='running'; block.actualStart=block.actualStart||Date.now();
  dbPut('studyBlocks',block);
  if (!state.runningTimers[id]) state.runningTimers[id]={elapsed:block.elapsed||0};
  state.runningTimers[id].startedAt=Date.now();
  state.runningTimers[id].interval=setInterval(()=>{
    const t=state.runningTimers[id];
    t.elapsed=(block.elapsed||0)+Math.floor((Date.now()-t.startedAt)/1000);
    const te=el('timer-'+id); if(te) te.textContent=fmtTime(t.elapsed);
    const pe=el('prog-'+id); if(pe) pe.style.width=Math.min(100,(t.elapsed/(block.duration*60))*100)+'%';
    calculateTodayExecution();
  },1000);
  renderBlocks();
}
function pauseBlock(id) {
  const block=state.blocks.find(b=>b.id===id);
  if (!block||block.status!=='running') return;
  const t=state.runningTimers[id];
  if (t) { clearInterval(t.interval); block.elapsed=t.elapsed; }
  block.status='paused';
  dbPut('studyBlocks',block);
  adjustMetric('Focus',-2);
  logInterruption(id,'manual pause');
  renderBlocks();
  showToast('Block paused — Focus -2');
}
async function completeBlock(id) {
  const block=state.blocks.find(b=>b.id===id);
  if (!block) return;
  const t=state.runningTimers[id];
  if (t) { clearInterval(t.interval); block.elapsed=t.elapsed; delete state.runningTimers[id]; }
  block.status='completed';
  await dbPut('studyBlocks',block);
  renderBlocks();
  await calculateTodayExecution();
  await updateStreaks(); await updateRank();
  renderDashboard();
  showToast(`Block complete: ${block.subject}`);
}
async function logInterruption(blockId,reason) {
  await dbAdd('interruptions',{blockId,reason,timestamp:Date.now(),date:today()});
}
document.addEventListener('visibilitychange',()=>{
  if (document.hidden) {
    Object.keys(state.runningTimers).forEach(id=>{
      const b=state.blocks.find(b=>b.id==id);
      if (b&&b.status==='running') { pauseBlock(parseInt(id)); showToast('Auto-paused: tab hidden — Focus -2'); }
    });
  }
});

// ================================================================
// RENDER BLOCKS
// ================================================================
function renderBlocks(container) {
  const el2=container||el('blocksList');
  if (!el2) return;
  const dateFilter=container?null:today();
  const blocks=dateFilter?state.blocks.filter(b=>b.date===dateFilter):state.blocks;
  if (!blocks.length) {
    el2.innerHTML='<div class="no-data-inline">No blocks for today. Use the button above to add your first study session.</div>';
    return;
  }
  el2.innerHTML=blocks.map(b=>blockHTML(b)).join('');
  el2.querySelectorAll('.block-card[draggable]').forEach(card=>{
    card.addEventListener('dragstart',e=>{state.dragBlockId=parseInt(card.dataset.id);e.dataTransfer.effectAllowed='move';});
    card.addEventListener('dragover',e=>{e.preventDefault();card.classList.add('drag-over');});
    card.addEventListener('dragleave',()=>card.classList.remove('drag-over'));
    card.addEventListener('drop',e=>{e.preventDefault();card.classList.remove('drag-over');swapBlocks(state.dragBlockId,parseInt(card.dataset.id));});
  });
}
function blockHTML(b) {
  const elapsed=(state.runningTimers[b.id]&&state.runningTimers[b.id].elapsed)||b.elapsed||0;
  const pct=Math.min(100,(elapsed/(b.duration*60))*100);
  const sc=b.status==='running'?'running':b.status==='paused'?'paused':b.status==='completed'?'done':'idle';
  const cc=b.status==='completed'?'completed':b.status==='running'?'running':b.status==='paused'?'paused':'';
  const eff=elapsed>0?(b.completedTests/(elapsed/3600)).toFixed(1):null;
  const cat=b.subjectCategory||classifySubject(b.subject);
  const catColor=subjectCatColor(cat);
  const objRTL=b.blockObject&&isRTL(b.blockObject);
  return `<div class="block-card ${cc}" draggable="true" data-id="${b.id}">
    <div class="block-header">
      <div class="block-subject">${b.subject}<span class="subject-cat-badge" style="background:${catColor}22;color:${catColor};border-color:${catColor}44">${cat}</span></div>
      <span class="status-badge ${sc}">${b.status.toUpperCase()}</span>
    </div>
    ${b.blockObject?`<div class="block-object ${objRTL?'':'ltr'}">${b.blockObject}</div>`:''}
    <div class="block-meta">
      <span>⏱ ${b.duration}m</span>
      ${b.startTime?`<span>🕐 ${b.startTime}</span>`:''}
      <span>📋 ${b.completedTests||0}/${b.tests} tests</span>
      <span>📅 ${b.date}</span>
      ${eff!==null?`<span class="test-efficiency-badge">${eff} t/hr</span>`:''}
    </div>
    <div class="block-timer" id="timer-${b.id}">${fmtTime(elapsed)}</div>
    <div class="block-controls">
      ${b.status!=='completed'&&b.status!=='running'?`<button class="btn btn-primary btn-sm" onclick="startBlock(${b.id})">START</button>`:''}
      ${b.status==='running'?`<button class="btn btn-sm" onclick="pauseBlock(${b.id})">PAUSE</button>`:''}
      ${b.status!=='completed'?`<button class="btn btn-sm" onclick="completeBlock(${b.id})">COMPLETE</button>`:''}
      <button class="btn btn-sm" onclick="editBlock(${b.id})">EDIT</button>
      <button class="btn btn-danger btn-sm" onclick="deleteBlock(${b.id})">✕</button>
    </div>
    <div class="test-log-row">
      <span class="test-log-label">TESTS DONE:</span>
      <input class="test-log-input" type="number" min="0" value="${b.completedTests||0}" onchange="updateCompletedTests(${b.id},this.value)" placeholder="0">
      <span style="font-size:10px;color:var(--text3);font-family:var(--font-mono)">/ ${b.tests} target</span>
    </div>
    <div class="block-progress"><div class="block-progress-fill" id="prog-${b.id}" style="width:${pct}%"></div></div>
  </div>`;
}
function swapBlocks(id1,id2) {
  if (id1===id2) return;
  const b1=state.blocks.find(b=>b.id===id1),b2=state.blocks.find(b=>b.id===id2);
  if (!b1||!b2) return;
  [b1.date,b2.date]=[b2.date,b1.date];
  [b1.startTime,b2.startTime]=[b2.startTime,b1.startTime];
  dbPut('studyBlocks',b1); dbPut('studyBlocks',b2);
  renderBlocks(); renderCalendar();
}

// ================================================================
// EXECUTION CALCULATION — UPDATED FORMULA
// Study Hours ×0.4 + Block Completion ×0.2 + Test Volume ×0.4
// ================================================================
async function calculateTodayExecution() {
  const todayBlocks = state.blocks.filter(b=>b.date===today());
  const todayLog = state.todayLog||{date:today(),plannedHours:0,dailyTestTarget:0};
  const plannedSec = (todayLog.plannedHours||0)*3600;
  const plannedTests = todayLog.dailyTestTarget||0;

  let completedSec=0;
  todayBlocks.forEach(b=>{
    const e=(state.runningTimers[b.id]&&state.runningTimers[b.id].elapsed)||b.elapsed||0;
    completedSec+=e;
  });
  const completedBlocks=todayBlocks.filter(b=>b.status==='completed').length;
  const totalBlocks=Math.max(1,todayBlocks.length);
  const totalCompletedTests=todayBlocks.reduce((s,b)=>s+(b.completedTests||0),0);
  const totalTargetTests=Math.max(1,todayBlocks.reduce((s,b)=>s+(b.tests||0),0));

  // New dual-weighted formula
  const hourScore = plannedSec>0?Math.min(1,completedSec/plannedSec):0;
  const blockScore = completedBlocks/totalBlocks;
  const testScore = plannedTests>0?Math.min(1,totalCompletedTests/plannedTests):Math.min(1,totalCompletedTests/totalTargetTests);
  const weighted = (hourScore*0.4 + blockScore*0.2 + testScore*0.4)*100;

  await saveMetric('Execution',Math.round(weighted));

  // Test efficiency
  const effVal = completedSec>0?(totalCompletedTests/(completedSec/3600)).toFixed(1):null;

  // UI updates
  setText('execScoreBig',Math.round(weighted)+'%');
  const pb=el('execProgressBar'); if(pb) pb.style.width=weighted+'%';
  setText('dash-completed',fmtHr(completedSec));
  setText('dash-planned',(todayLog.plannedHours||0)+'h');
  setText('dash-tests',totalCompletedTests);
  setText('dash-testsTarget',plannedTests||totalTargetTests);
  setText('dash-hoursTotal',fmtHr(completedSec));
  setText('dash-testsTotal',totalCompletedTests);

  // Efficiency
  const effEl=el('testEfficiencyVal');
  const effBar=el('testEfficiencyBar');
  const effRating=el('testEfficiencyRating');
  if (effEl) {
    if (effVal!==null) {
      effEl.textContent=effVal;
      const ef=parseFloat(effVal);
      if(effBar) effBar.style.width=Math.min(100,ef*5)+'%';
      if(effRating) effRating.textContent=ef>=15?'EXCELLENT':ef>=10?'STRONG':ef>=5?'MODERATE':ef>0?'LOW':'—';
    } else { effEl.textContent='—'; if(effRating) effRating.textContent='no data'; }
  }

  // Save log
  const log={date:today(),plannedHours:todayLog.plannedHours||0,dailyTestTarget:todayLog.dailyTestTarget||0,
    completedSec,completedBlocks,totalTests:totalCompletedTests,execPct:Math.round(weighted)};
  await dbPut('dailyLogs',log);
  state.todayLog=log;

  updateMissionPressure();
  checkCommandMode();
  calculateFatigue();
  return Math.round(weighted);
}

// ================================================================
// MISSION PRESSURE ENGINE
// ================================================================
async function loadMission() {
  const m=await dbGet('mission','primary');
  state.mission=m||null;
}
async function saveMission() {
  const date=el('missionDate').value;
  const hours=parseFloat(el('missionHours').value)||0;
  const testsReq=parseInt(el('missionTestsRequired').value)||0;
  const name=el('missionName').value.trim();
  if (!date||!hours) { showToast('Set target date and required hours'); return; }
  state.mission={id:'primary',targetDate:date,requiredHours:hours,requiredTests:testsReq,name};
  await dbPut('mission',state.mission);
  updateMissionPressure();
  showToast('Mission locked in: '+name);
}
async function updateMissionPressure() {
  const m=state.mission;
  const countdown=el('missionCountdown');
  if (!m) {
    if(countdown) { countdown.textContent='NO MISSION'; countdown.className='tpi-green'; }
    el('missionNoData').style.display='';
    el('missionActivePanel').style.display='none';
    return;
  }
  el('missionNoData').style.display='none';
  el('missionActivePanel').style.display='';

  const now=new Date(), target=new Date(m.targetDate);
  const daysLeft=Math.max(0,Math.ceil((target-now)/86400000));
  const logs=await dbGetAll('dailyLogs');
  const totalCompSec=logs.reduce((s,l)=>s+(l.completedSec||0),0);
  const totalCompTests=logs.reduce((s,l)=>s+(l.totalTests||0),0);
  const completedHrs=totalCompSec/3600;
  const remainHrs=Math.max(0,m.requiredHours-completedHrs);
  const remainTests=Math.max(0,(m.requiredTests||0)-totalCompTests);

  const recent7=logs.slice(-7);
  const avgSec=recent7.length?recent7.reduce((s,l)=>s+(l.completedSec||0),0)/recent7.length:3600*3;
  const capacity=Math.max(0.5,avgSec/3600);
  const tpi=daysLeft>0?remainHrs/(daysLeft*capacity):99;

  let cls='tpi-green';
  if(tpi>1.2) cls='tpi-red';
  else if(tpi>1.0) cls='tpi-orange';
  else if(tpi>0.8) cls='tpi-yellow';
  if(countdown) { countdown.className=cls; countdown.textContent=`${daysLeft}d · ${remainHrs.toFixed(0)}h · TPI ${tpi.toFixed(2)}`; }
  setText('headerRank',state.rank);

  const statsEl=el('missionStats');
  if(statsEl) statsEl.innerHTML=`
    <div class="tpi-stat"><div class="tpi-val">${daysLeft}</div><div class="tpi-label">Days Left</div></div>
    <div class="tpi-stat"><div class="tpi-val">${remainHrs.toFixed(0)}h</div><div class="tpi-label">Hours Left</div></div>
    <div class="tpi-stat"><div class="tpi-val">${capacity.toFixed(1)}h</div><div class="tpi-label">Daily Cap.</div></div>`;
  setText('missionHoursLeft',remainHrs.toFixed(0)+'h');
  setText('missionTestsLeft',remainTests>0?remainTests:'N/A');

  const tpiV=el('tpiVal'),tpiB=el('tpiBar');
  if(tpiV) { tpiV.textContent=tpi.toFixed(2); tpiV.style.color=tpi>1.2?'var(--danger)':tpi>1?'#ff7700':tpi>0.8?'var(--warn)':'var(--success)'; }
  if(tpiB) { tpiB.style.width=Math.min(100,tpi*60)+'%'; tpiB.style.background=tpi>1.2?'var(--danger)':tpi>1?'#ff7700':tpi>0.8?'var(--warn)':'var(--success)'; }

  const aEl=el('missionAdvisor');
  if(aEl) {
    aEl.style.display='block';
    const needed=daysLeft>0?remainHrs/daysLeft:remainHrs;
    let msg='',cls2='';
    if(tpi>1.2){msg=`CRITICAL. You need ${needed.toFixed(1)}h/day vs ${capacity.toFixed(1)}h realistic capacity. Immediate load increase required.`;cls2='critical';}
    else if(tpi>1.0){msg=`UNDER PRESSURE. Target ${needed.toFixed(1)}h/day. Current capacity: ${capacity.toFixed(1)}h. Marginal deficit.`;cls2='warn';}
    else if(tpi>0.8){msg=`MANAGEABLE. ${needed.toFixed(1)}h/day required. Maintain pace and avoid disruptions.`;cls2='warn';}
    else{msg=`ON TRACK. Pace exceeds requirement by ${(capacity-needed).toFixed(1)}h/day buffer.`;cls2='positive';}
    aEl.textContent=msg; aEl.className='advisor-msg mt-12 '+cls2;
  }

  // Populate form if empty
  if(el('missionDate')&&!el('missionDate').value) el('missionDate').value=m.targetDate;
  if(el('missionHours')&&!el('missionHours').value) el('missionHours').value=m.requiredHours;
  if(el('missionTestsRequired')&&!el('missionTestsRequired').value) el('missionTestsRequired').value=m.requiredTests||'';
  if(el('missionName')&&!el('missionName').value) el('missionName').value=m.name||'';
}

// ================================================================
// COMMAND MODE
// ================================================================
async function checkCommandMode() {
  const logs=await dbGetAll('dailyLogs');
  const r3=logs.slice(-3);
  const allLow=r3.length>=3&&r3.every(l=>l.execPct<80);
  const tpiHigh=el('missionCountdown')&&el('missionCountdown').className.includes('tpi-red');
  const banner=el('commandBanner');
  if(allLow&&tpiHigh){banner.classList.add('active');document.body.classList.add('command-mode');}
  else{banner.classList.remove('active');document.body.classList.remove('command-mode');}
  if(!allLow&&r3.length>=3&&r3.every(l=>l.execPct>=80)){
    document.body.classList.add('performance-glow');
    setTimeout(()=>document.body.classList.remove('performance-glow'),2000);
  }
}

// ================================================================
// FATIGUE INTELLIGENCE ENGINE — Extended with test density
// ================================================================
async function calculateFatigue() {
  const logs=await dbGetAll('dailyLogs');
  const todayBlocks=state.blocks.filter(b=>b.date===today());
  const ints=await dbGetAll('interruptions');
  const todayInts=ints.filter(i=>i.date===today()).length;
  const hoursToday=(logs.find(l=>l.date===today())?.completedSec||0)/3600;
  const testsToday=todayBlocks.reduce((s,b)=>s+(b.completedTests||0),0);
  const lateNight=todayBlocks.filter(b=>b.startTime&&parseInt(b.startTime.split(':')[0])>=21).length;
  const r3=logs.slice(-3);
  const consHigh=r3.filter(l=>l.execPct>=85).length;
  // Test density factor: more than 20 tests/hr is high mental load
  const testDensity=hoursToday>0?testsToday/hoursToday:0;
  let fatigue=100;
  fatigue-=hoursToday*4;
  fatigue-=lateNight*8;
  fatigue-=todayInts*3;
  fatigue-=consHigh*5;
  fatigue-=Math.max(0,(testDensity-10)*2); // penalty for very high test density
  fatigue=Math.max(0,Math.min(100,Math.round(fatigue)));
  state.fatigueIndex=fatigue;
  const bar=el('fatigueBar'),v=el('fatigueVal'),lbl=el('fatigueLabel'),adv=el('fatigueAdvice');
  if(!bar) return;
  bar.style.width=fatigue+'%';
  let col,ltext,atext;
  if(fatigue>=60){col='var(--success)';ltext='STABLE';atext='Cognitive reserves adequate. Maintain current rhythm.';}
  else if(fatigue>=40){col='var(--warn)';ltext='ELEVATED';atext='Fatigue accumulating. Consider reducing late-night sessions.';}
  else if(fatigue>=25){col='#ff7700';ltext='WARNING';atext='Warning threshold reached. A strategic rest block is advisable.';}
  else if(fatigue>=15){col='var(--danger)';ltext='BURNOUT RISK';atext='Burnout risk active. Quality of output is degrading. Rest is a tactical decision.';}
  else{col='#ff0055';ltext='CRITICAL';atext='Critical cognitive depletion. Mandatory rest. Performance is severely impaired.';}
  bar.style.background=col;
  if(lbl){lbl.textContent=ltext;lbl.style.color=col;}
  if(v) v.textContent=fatigue;
  if(adv) adv.textContent=atext;
  await dbAdd('fatigueHistory',{date:today(),fatigue,timestamp:Date.now()});
}

// ================================================================
// STREAK ENGINE
// ================================================================
async function updateStreaks() {
  const logs=(await dbGetAll('dailyLogs')).sort((a,b)=>b.date.localeCompare(a.date));
  let study=0;
  for(const l of logs){if(l.execPct>=85) study++; else break;}
  const doneToday=state.blocks.filter(b=>b.date===today()&&b.status==='completed').length;
  let dw=(await dbGet('streaks','deepWork'))?.count||0;
  if(doneToday>=4) dw++; else dw=0;
  state.streaks.study=study; state.streaks.deepWork=dw;
  await dbPut('streaks',{type:'study',count:study});
  await dbPut('streaks',{type:'deepWork',count:dw});
  setText('studyStreakVal',study); setText('deepWorkStreakVal',dw);
}

// ================================================================
// RANK ENGINE
// ================================================================
async function updateRank() {
  const logs=await dbGetAll('dailyLogs');
  const week=logs.slice(-7);
  const avgExec=week.length?week.reduce((s,l)=>s+(l.execPct||0),0)/week.length:0;
  const score=avgExec*0.5+state.metrics.Momentum*0.3+Math.min(100,state.streaks.study*10)*0.2;
  let rank,icon;
  if(score>=90){rank='ELITE';icon='⭐';}
  else if(score>=75){rank='GOLD';icon='🔶';}
  else if(score>=60){rank='SILVER';icon='⬡';}
  else if(score>=40){rank='BRONZE';icon='▲';}
  else{rank='IRON';icon='⚙';}
  state.rank=rank;
  setText('rankIcon',icon); setText('rankName',rank);
  setText('rankScore',week.length?`Score: ${Math.round(score)} · ${week.length}-day basis`:'Log activity to receive ranking');
  setText('headerRank',rank);
}

// ================================================================
// HABITS ENGINE
// ================================================================
async function loadHabits() { state.habits=await dbGetAll('habits'); }
function openAddHabit() { el('habitName').value=''; el('habitPenalty').value='3'; openModal('addHabitModal'); }
async function saveHabit() {
  const name=el('habitName').value.trim();
  const penalty=parseInt(el('habitPenalty').value)||3;
  if(!name){showToast('Enter habit name');return;}
  const h={name,penalty};
  h.id=await dbAdd('habits',h);
  state.habits.push(h);
  closeModal('addHabitModal'); renderHabits();
}
async function deleteHabit(id) { await dbDelete('habits',id); state.habits=state.habits.filter(h=>h.id!==id); renderHabits(); }
async function logHabit(id,avoided) {
  const h=state.habits.find(x=>x.id===id);
  if(!h) return;
  if(avoided){await adjustMetric('Discipline',2);await adjustMetric('Momentum',1);showToast(`Avoided "${h.name}" — Discipline +2, Momentum +1`);}
  else{await adjustMetric('Focus',-h.penalty);await adjustMetric('Momentum',-h.penalty);showToast(`Performed "${h.name}" — Focus -${h.penalty}, Momentum -${h.penalty}`);}
  renderAllMetrics();
}
function renderHabits() {
  const listEl=el('habitsList'),dayEl=el('habitDailyLog');
  if(!listEl) return;
  if(!state.habits.length){
    listEl.innerHTML='<div class="no-data-inline">No habits tracked. Add your first habit to begin monitoring behavioral compliance.</div>';
    if(dayEl) dayEl.innerHTML='<div class="text-muted">Add habits above to track them daily.</div>';
    return;
  }
  listEl.innerHTML=state.habits.map(h=>`<div class="habit-item">
    <div><div class="habit-name">${h.name}</div><div class="habit-penalty">Penalty: -${h.penalty}</div></div>
    <button class="btn btn-danger btn-sm" onclick="deleteHabit(${h.id})">REMOVE</button>
  </div>`).join('');
  if(dayEl) dayEl.innerHTML=state.habits.map(h=>`<div class="habit-item">
    <div class="habit-name">${h.name}</div>
    <div class="habit-controls">
      <button class="btn btn-sm" onclick="logHabit(${h.id},true)" style="border-color:var(--success);color:var(--success)">AVOIDED ✓</button>
      <button class="btn btn-danger btn-sm" onclick="logHabit(${h.id},false)">PERFORMED ✗</button>
    </div>
  </div>`).join('');
}

// ================================================================
// CALENDAR ENGINE
// ================================================================
function renderCalendar() {
  const cv=state.calView;
  el('calView-month').classList.toggle('hidden',cv!=='month');
  el('calView-week').classList.toggle('hidden',cv!=='week');
  el('calView-day').classList.toggle('hidden',cv!=='day');
  el('calViewMonth').classList.toggle('btn-active',cv==='month');
  el('calViewWeek').classList.toggle('btn-active',cv==='week');
  el('calViewDay').classList.toggle('btn-active',cv==='day');
  if(cv==='month') renderMonthView();
  else if(cv==='week') renderWeekView();
  else renderDayView();
}
function setCalView(v){state.calView=v;renderCalendar();}
function renderMonthView() {
  const d=state.calDate,y=d.getFullYear(),m=d.getMonth();
  setText('calMonthTitle',`${monthNames[m]} ${y}`);
  const grid=el('calGrid');
  let html=dayNames.map(n=>`<div class="cal-dayname">${n}</div>`).join('');
  const first=new Date(y,m,1),last=new Date(y,m+1,0),pad=first.getDay(),todayS=today();
  for(let i=0;i<pad;i++){const pd=new Date(y,m,-pad+i+1);html+=`<div class="cal-cell other-month"><div class="cal-date">${pd.getDate()}</div></div>`;}
  for(let day=1;day<=last.getDate();day++){
    const ds=`${y}-${pad2(m+1)}-${pad2(day)}`;
    const db=state.blocks.filter(b=>b.date===ds);
    const isT=ds===todayS;
    const ep=db.length?Math.round(db.filter(b=>b.status==='completed').length/db.length*100):0;
    const ec=ep>=85?'var(--success)':ep>=60?'var(--warn)':ep>0?'var(--danger)':'var(--border2)';
    html+=`<div class="cal-cell${isT?' today':''}" onclick="openDayFromCal('${ds}')">
      <div class="cal-date">${day}</div>
      ${db.slice(0,2).map(b=>`<div class="cal-block-dot">• ${b.subject}</div>`).join('')}
      ${db.length>2?`<div class="cal-block-dot">+${db.length-2}</div>`:''}
      ${db.length?`<div class="cal-exec-bar"><div class="cal-exec-fill" style="width:${ep}%;background:${ec}"></div></div>`:''}
    </div>`;
  }
  const ep2=(7-(pad+last.getDate())%7)%7;
  for(let i=1;i<=ep2;i++) html+=`<div class="cal-cell other-month"><div class="cal-date">${i}</div></div>`;
  grid.innerHTML=html;
}
function calNav(dir){const d=state.calDate;state.calDate=new Date(d.getFullYear(),d.getMonth()+dir,1);renderCalendar();}
function openDayFromCal(ds){state.dayView=parseDate(ds);state.calView='day';renderCalendar();}
function renderWeekView() {
  const now=new Date(),ws=new Date(now);
  ws.setDate(now.getDate()-now.getDay()+state.weekOffset*7);
  const days=Array.from({length:7},(_,i)=>{const d=new Date(ws);d.setDate(ws.getDate()+i);return d;});
  const todayS=today();
  setText('calWeekTitle',`Week of ${monthNames[ws.getMonth()]} ${ws.getDate()}, ${ws.getFullYear()}`);
  let html='<div class="week-time"></div>'+days.map(d=>{const ds=dateStr(d);const it=ds===todayS;return`<div class="week-dayhead${it?' today-col':''}">${dayNames[d.getDay()]}<br>${d.getDate()}</div>`;}).join('');
  for(let h=0;h<24;h++){
    html+=`<div class="week-time">${pad2(h)}:00</div>`;
    days.forEach(d=>{
      const ds=dateStr(d);
      const bh=state.blocks.filter(b=>b.date===ds&&b.startTime&&parseInt(b.startTime.split(':')[0])===h);
      html+=`<div class="week-cell" onclick="openDayFromCal('${ds}')">
        ${bh.map(b=>`<div class="week-block-item">${b.subject}</div>`).join('')}
      </div>`;
    });
  }
  el('weekGrid').innerHTML=html;
  el('weekGrid').style.gridTemplateColumns='50px repeat(7,1fr)';
}
function weekNav(dir){state.weekOffset+=dir;renderCalendar();}
function renderDayView() {
  const ds=dateStr(state.dayView);
  setText('calDayTitle',`${dayNames[state.dayView.getDay()]}, ${monthNames[state.dayView.getMonth()]} ${state.dayView.getDate()}, ${state.dayView.getFullYear()}`);
  const db=state.blocks.filter(b=>b.date===ds);
  const comp=db.filter(b=>b.status==='completed').length;
  const cSec=db.reduce((s,b)=>s+(b.elapsed||0),0);
  const tests=db.reduce((s,b)=>s+(b.completedTests||0),0);
  const ep=db.length?Math.round(comp/db.length*100):0;
  const ph=db.reduce((s,b)=>s+b.duration/60,0);
  const statsEl=el('dayPanelStats');
  if(statsEl) statsEl.innerHTML=`
    <div class="tpi-stat"><div class="tpi-val">${ph.toFixed(1)}h</div><div class="tpi-label">Planned</div></div>
    <div class="tpi-stat"><div class="tpi-val">${fmtHr(cSec)}</div><div class="tpi-label">Completed</div></div>
    <div class="tpi-stat"><div class="tpi-val">${tests}</div><div class="tpi-label">Tests</div></div>
    <div class="tpi-stat"><div class="tpi-val">${ep}%</div><div class="tpi-label">Execution</div></div>
    <div class="tpi-stat"><div class="tpi-val">${comp}/${db.length}</div><div class="tpi-label">Blocks</div></div>
    <div class="tpi-stat"><div class="tpi-val">${ph>=10?'HEAVY':ph>=6?'BALANCED':ph>=3?'MODERATE':'LIGHT'}</div><div class="tpi-label">Load</div></div>`;
  const rating=getTacticalRating(db,ep);
  const rEl=el('dayTacticalRating');
  if(rEl){rEl.textContent=rating.msg;rEl.className='advisor-msg mt-8 '+rating.type;}
  const dl=el('dayBlocksList');
  if(dl) renderBlocks(dl);
}
function dayNav(dir){state.dayView=addDays(state.dayView,dir);renderCalendar();}
function getTacticalRating(blocks,ep) {
  const hrs=blocks.reduce((s,b)=>s+b.duration/60,0);
  const fi=state.fatigueIndex;
  if(hrs>12) return{type:'critical',msg:'OVERLOADED: Volume exceeds sustainable cognitive capacity. Redistribute blocks.'};
  if(fi!==null&&fi<25&&hrs>6) return{type:'warn',msg:'WARNING: Heavy load combined with critical fatigue. Output quality severely compromised.'};
  if(hrs>8) return{type:'warn',msg:'HEAVY: Approaching upper cognitive load threshold. Monitor execution closely.'};
  if(ep<60&&blocks.length>0) return{type:'warn',msg:'UNDERPERFORMING: Execution below 60%. Diagnose the friction—environmental or scheduling issue.'};
  if(hrs<3) return{type:'warn',msg:'UNDERLOADED: Low planned volume. Review mission requirements and adjust targets.'};
  return{type:'positive',msg:'BALANCED: Day structure is sustainable and well-distributed.'};
}

// ================================================================
// PERFORMANCE HISTORY BARS
// ================================================================
async function renderPerfBars() {
  const logs=await dbGetAll('dailyLogs');
  const week=logs.slice(-7);
  const el2=el('perfBars');
  if(!el2) return;
  if(!week.length){el2.innerHTML='<div class="text-muted" style="font-size:10px">Log study sessions to see history</div>';return;}
  el2.innerHTML=week.map(l=>{
    const h=Math.round(l.execPct||0);
    const c=h>=85?'var(--success)':h>=60?'var(--accent)':h>=40?'var(--warn)':'var(--danger)';
    return`<div class="perf-bar-col">
      <div class="perf-bar" style="height:${h*0.5}px;background:${c}"></div>
      <div class="perf-bar-day">${l.date.slice(5)}</div>
    </div>`;
  }).join('');
}

// ================================================================
// ADVISOR ENGINE — Extended with behavioral memory + test/hour balance
// ================================================================
async function generateAdvisory() {
  const logs=await dbGetAll('dailyLogs');
  const ints=await dbGetAll('interruptions');
  const msgs=[];
  const week=logs.slice(-7);
  const avgExec=week.length?Math.round(week.reduce((s,l)=>s+(l.execPct||0),0)/week.length):null;
  const allAvgExec=logs.length?Math.round(logs.reduce((s,l)=>s+(l.execPct||0),0)/logs.length):null;

  if(logs.length<3){
    el('advisoryList').innerHTML=`<div class="advisor-msg warn">Insufficient historical data to produce meaningful analysis. Log at least 3 study days to enable the advisory engine.</div>`;
    return;
  }

  // Weekly execution
  if(avgExec!==null){
    if(avgExec<60) msgs.push({type:'critical',text:`Weekly execution is critically low at ${avgExec}%. This represents a systematic failure in follow-through. Immediate diagnosis required.`});
    else if(avgExec<80) msgs.push({type:'warn',text:`Weekly execution at ${avgExec}%—below the 80% operational threshold. Identify which blocks are consistently incomplete and address root cause.`});
    else msgs.push({type:'positive',text:`Weekly execution averaging ${avgExec}%. Performance is within the high-execution corridor. Consistency is the priority now.`});
  }

  // Behavioral memory: compare recent vs long-term
  if(logs.length>=7&&allAvgExec!==null&&avgExec!==null){
    const diff=avgExec-allAvgExec;
    if(diff>=10) msgs.push({type:'positive',text:`This week shows notable recovery. Recent ${avgExec}% execution versus long-term average of ${allAvgExec}% suggests deliberate course correction rather than noise.`});
    else if(diff<=-10) msgs.push({type:'warn',text:`Recent performance at ${avgExec}% is tracking ${Math.abs(diff)} points below your long-term average of ${allAvgExec}%. This signals a pattern break, not a single bad day.`});
    else msgs.push({type:'positive',text:`Recent performance (${avgExec}%) aligns with your long-term average of ${allAvgExec}%. This reflects sustained discipline rather than isolated effort.`});
  }

  // Focus
  const focus=state.metrics.Focus;
  if(focus<50) msgs.push({type:'warn',text:`Focus currently at ${focus}. This is below operational baseline. Audit your session environment—interruptions, device distractions, or sleep quality are likely culprits.`});
  else if(focus>80) msgs.push({type:'positive',text:`Focus index at ${focus}. Leverage this state for your most cognitively demanding subjects during this period.`});

  // Discipline
  const disc=state.metrics.Discipline;
  if(disc<50) msgs.push({type:'critical',text:`Discipline at ${disc}—a warning indicator. Late block starts are the primary driver. Enforce a rigid morning routine and pre-commit session times the night before.`});

  // Interruptions
  if(ints.length>0){
    const hourMap={};
    ints.forEach(i=>{const h=new Date(i.timestamp).getHours();hourMap[h]=(hourMap[h]||0)+1;});
    const maxH=Object.keys(hourMap).sort((a,b)=>hourMap[b]-hourMap[a])[0];
    const maxC=hourMap[maxH];
    msgs.push({type:'warn',text:`${maxC} interruptions recorded between ${maxH}:00–${parseInt(maxH)+1}:00. This is your highest-friction hour. Treat it as a protected block or schedule low-stakes tasks during this window.`});
  }

  // Subject intelligence advisory
  const allB=await dbGetAll('studyBlocks');
  const recent14Blocks=allB.filter(b=>b.date>=dateStr(addDays(new Date(),-14)));
  if(recent14Blocks.length>0){
    const sa=computeSubjectAnalytics(recent14Blocks);
    if(sa.subjects.length>0){
      const top=sa.subjects[0];
      if(top.dominance>60) msgs.push({type:'warn',text:`Subject imbalance detected: ${top.name} accounts for ${top.dominance.toFixed(0)}% of the last 14 days' study time. This concentration may compromise coverage of other subjects.`});
      if(sa.neglected.length>0) msgs.push({type:'critical',text:`Neglected subjects (no logged hours in 14 days): ${sa.neglected.join(', ')}. These represent hidden examination risk. Immediately schedule recovery blocks.`});
      const highEffSubj=sa.subjects.find(s=>s.efficiency>12);
      if(highEffSubj) msgs.push({type:'positive',text:`Active recall mastery detected in ${highEffSubj.name}: ${highEffSubj.efficiency.toFixed(1)} tests/hr. Replicate this methodology in lower-efficiency subjects.`});
      const lowEffSubj=sa.subjects.find(s=>s.efficiency<3&&s.hours>2);
      if(lowEffSubj) msgs.push({type:'warn',text:`Passive study pattern in ${lowEffSubj.name}: only ${lowEffSubj.efficiency.toFixed(1)} tests/hr despite ${lowEffSubj.hours.toFixed(1)}h logged. Hours without testing creates an illusion of progress.`});
    }
    // Heatmap pattern analysis (last 7 days)
    const last7Days = Array.from({length:7},(_,i)=>addDays(new Date(),-6+i));
    const md = buildMatrixData(last7Days, allB);
    let emptyDays=0, spikeDays=[], clusterSubj=null, maxSubjHrs=0;
    last7Days.forEach(d=>{
      const ds=dateStr(d);
      const dayTotal=SUBJECT_MATRIX_LABELS.reduce((s,sub)=>s+(md[sub]?.[ds]?.hours||0),0);
      if(dayTotal===0) emptyDays++;
      if(dayTotal>8) spikeDays.push(fmtDateShort(d)+' ('+dayTotal.toFixed(1)+'h)');
    });
    SUBJECT_MATRIX_LABELS.forEach(sub=>{
      const subTotal=last7Days.reduce((s,d)=>s+(md[sub]?.[dateStr(d)]?.hours||0),0);
      if(subTotal>maxSubjHrs){maxSubjHrs=subTotal;clusterSubj=sub;}
    });
    if(emptyDays>=2) msgs.push({type:'warn',text:`Heatmap analysis: ${emptyDays} zero-study days detected in the last 7 days. These gaps disproportionately reduce retention and compound into larger deficits over time.`});
    if(spikeDays.length) msgs.push({type:'warn',text:`High-volume spikes detected: ${spikeDays.join(', ')}. Single-day overloads reduce average retention efficiency. Distribute volume more evenly.`});
    if(clusterSubj&&maxSubjHrs>5) msgs.push({type:'positive',text:`Subject clustering analysis: ${clusterSubj} received the highest weekly matrix volume at ${maxSubjHrs.toFixed(1)}h. Ensure complementary subjects receive proportional scheduling.`});
  }

  // Test / Hour balance (critical new analysis)
  const totalHrs=logs.reduce((s,l)=>s+(l.completedSec||0),0)/3600;
  const totalTests=logs.reduce((s,l)=>s+(l.totalTests||0),0);
  const overallEff=totalHrs>0?totalTests/totalHrs:null;
  if(overallEff!==null){
    if(totalHrs>10&&overallEff<3) msgs.push({type:'warn',text:`High study hours (${totalHrs.toFixed(1)}h logged) but low test density (${overallEff.toFixed(1)} tests/hr). Passive reading is accumulating—integrate active recall exercises into every session.`});
    else if(totalTests>20&&totalHrs<5) msgs.push({type:'warn',text:`High test volume (${totalTests} tests) relative to ${totalHrs.toFixed(1)}h logged. Consider longer uninterrupted study blocks to complement your active recall with depth.`});
    else if(totalTests>20&&totalHrs>5) msgs.push({type:'positive',text:`Strong balance between study volume (${totalHrs.toFixed(1)}h) and test throughput (${totalTests} tests / ${overallEff.toFixed(1)}/hr). This dual-metric performance is optimal.`});
    else if(totalTests<5&&totalHrs<5) msgs.push({type:'critical',text:`Both study hours and test volume are minimal. The system lacks sufficient data to assess performance—and your mission timeline is not being addressed.`});
  }

  // Mission pressure
  if(state.mission){
    const daysLeft=Math.max(1,Math.ceil((new Date(state.mission.targetDate)-new Date())/86400000));
    const comp=logs.reduce((s,l)=>s+(l.completedSec||0),0)/3600;
    const remain=state.mission.requiredHours-comp;
    const needed=remain/daysLeft;
    const cap=week.length?week.reduce((s,l)=>s+(l.completedSec||0),0)/3600/week.length:3;
    if(needed>cap*1.2) msgs.push({type:'critical',text:`Mission pace analysis: you require ${needed.toFixed(1)}h/day to meet your deadline, against a realistic capacity of ${cap.toFixed(1)}h/day. Current pace insufficient by ${(needed-cap).toFixed(1)}h/day.`});
    else if(needed<=cap*0.8) msgs.push({type:'positive',text:`Mission trajectory favorable. Daily requirement of ${needed.toFixed(1)}h is comfortably within your ${cap.toFixed(1)}h capacity. Maintain current velocity.`});
  }

  // Fatigue
  if(state.fatigueIndex!==null){
    if(state.fatigueIndex<25) msgs.push({type:'critical',text:`Fatigue index at ${state.fatigueIndex}—critical depletion. Attempting to push through will degrade output quality and increase error rates. Tactical rest is not optional.`});
    else if(state.fatigueIndex<40) msgs.push({type:'warn',text:`Elevated fatigue (${state.fatigueIndex}). Schedule a recovery session within 48 hours. Prioritize sleep duration over study hours tonight.`});
  }

  // 4-day execution decline
  const l4=logs.slice(-4);
  if(l4.length===4){
    const dec=l4.every((l,i)=>i===0||l.execPct<=l4[i-1].execPct);
    if(dec&&l4[3].execPct<70) msgs.push({type:'critical',text:`Four-day execution decline: ${l4.map(l=>l.execPct+'%').join(' → ')}. This is a sustained negative trajectory. Root cause analysis needed: fatigue accumulation, scheduling errors, or motivation deficit.`});
  }

  // Heavy day warning
  const h3=week.slice(-3).filter(l=>l.plannedHours>=8).length;
  if(h3===3) msgs.push({type:'warn',text:`Three consecutive high-load days detected. Cognitive saturation is a real risk at this point. Insert a deliberate lighter session or recovery block before the next heavy day.`});

  // Momentum
  if(state.metrics.Momentum>80) msgs.push({type:'positive',text:`Momentum at ${state.metrics.Momentum}—a strong operational signal. Current systems are working. Avoid disrupting the routine unnecessarily.`});

  const listEl=el('advisoryList');
  if(!msgs.length){listEl.innerHTML='<div class="no-data-inline">Log more sessions to generate advisory insights.</div>';return;}
  listEl.innerHTML=msgs.map(m=>`<div class="advisor-msg ${m.type}">
    <span style="font-size:8px;letter-spacing:2px;display:block;margin-bottom:6px;color:var(--text3)">${m.type.toUpperCase()} · ADVISORY</span>
    ${m.text}
  </div>`).join('');
}

// ================================================================
// SUBJECT ANALYTICS ENGINE
// Computes per-subject stats from blocks array
// ================================================================
function computeSubjectAnalytics(blocks) {
  const cats = {};
  blocks.forEach(b => {
    const cat = b.subjectCategory || classifySubject(b.subject);
    if (!cats[cat]) cats[cat] = { name:cat, hours:0, tests:0, blocks:0, completedBlocks:0 };
    const elapsed = b.elapsed || 0;
    cats[cat].hours += elapsed / 3600;
    cats[cat].tests += b.completedTests || 0;
    cats[cat].blocks++;
    if (b.status === 'completed') cats[cat].completedBlocks++;
  });
  const totalHrs = Object.values(cats).reduce((s,c) => s + c.hours, 0);
  const subjects = Object.values(cats).map(c => ({
    ...c,
    efficiency: c.hours > 0 ? c.tests / c.hours : 0,
    dominance: totalHrs > 0 ? (c.hours / totalHrs) * 100 : 0,
  })).sort((a,b) => b.hours - a.hours);
  // Imbalance: any MATRIX_LABEL with 0h logged
  const presentCats = new Set(subjects.map(s => s.name));
  const neglected = SUBJECT_MATRIX_LABELS.filter(l => !presentCats.has(l));
  return { subjects, neglected, totalHrs };
}

// Build matrix data: { 'زیست': { 'Mon': {hours, tests} }, ... }
function buildMatrixData(weekDays, allBlocks) {
  const data = {};
  SUBJECT_MATRIX_LABELS.forEach(s => {
    data[s] = {};
    weekDays.forEach(d => { data[s][dateStr(d)] = { hours:0, tests:0 }; });
  });
  weekDays.forEach(d => {
    const ds = dateStr(d);
    const dayBlocks = allBlocks.filter(b => b.date === ds);
    dayBlocks.forEach(b => {
      const cat = b.subjectCategory || classifySubject(b.subject);
      if (data[cat]) {
        data[cat][ds].hours += (b.elapsed || 0) / 3600;
        data[cat][ds].tests += b.completedTests || 0;
      }
    });
  });
  return data;
}

// ================================================================
// REPORT ENGINE
// ================================================================
let reportState = { quick:null, start:null, end:null };

function setReportQuick(q) {
  reportState.quick=q;
  const now=new Date();
  let s,e;
  if(q==='thisweek'){const ws=new Date(now);ws.setDate(now.getDate()-now.getDay());s=dateStr(ws);e=today();}
  else if(q==='lastweek'){const we=new Date(now);we.setDate(now.getDate()-now.getDay()-1);const ws=new Date(we);ws.setDate(we.getDate()-6);s=dateStr(ws);e=dateStr(we);}
  else if(q==='thismonth'){s=`${now.getFullYear()}-${pad2(now.getMonth()+1)}-01`;e=today();}
  else if(q==='last30'){s=dateStr(addDays(now,-30));e=today();}
  else if(q==='custom'){el('reportCustomRange').style.display='flex';updateRangeLabel();return;}
  reportState.start=s; reportState.end=e;
  el('reportCustomRange').style.display='none';
  // Highlight active btn
  ['thisweek','lastweek','thismonth','last30','custom'].forEach(k=>{
    const b=el('rq-'+k);if(b) b.classList.toggle('btn-active',k===q);
  });
  updateRangeLabel();
}
function updateRangeLabel() {
  if(reportState.quick==='custom'){
    const s=el('reportStart').value,e=el('reportEnd').value;
    reportState.start=s; reportState.end=e;
    setText('reportRangeLabel',s&&e?`RANGE: ${s} → ${e}`:'Set start and end date above');
  } else if(reportState.start&&reportState.end){
    setText('reportRangeLabel',`RANGE: ${reportState.start} → ${reportState.end}`);
  }
}
el('reportStart').addEventListener('change',updateRangeLabel);
el('reportEnd').addEventListener('change',updateRangeLabel);

async function generateReport() {
  if(reportState.quick==='custom'){
    reportState.start=el('reportStart').value;
    reportState.end=el('reportEnd').value;
  }
  if(!reportState.start||!reportState.end){showToast('Select a time range first');return;}
  const allLogs=await dbGetAll('dailyLogs');
  const allInts=await dbGetAll('interruptions');
  const allFatigue=await dbGetAll('fatigueHistory');
  const allBlocks=await dbGetAll('studyBlocks');
  const s=reportState.start,e=reportState.end;

  // Filter logs in range
  const rangeLogs=allLogs.filter(l=>l.date>=s&&l.date<=e);

  // Compute previous equal-length range
  const rangeLen=Math.ceil((parseDate(e)-parseDate(s))/86400000)+1;
  const prevEnd=dateStr(addDays(parseDate(s),-1));
  const prevStart=dateStr(addDays(parseDate(s),-rangeLen));
  const prevLogs=allLogs.filter(l=>l.date>=prevStart&&l.date<=prevEnd);

  const curLogs=allLogs.slice(-7);
  const longTermLogs=allLogs;

  if(rangeLogs.length===0){
    el('reportOutput').innerHTML=`<div class="report-empty"><div class="report-empty-icon">◈</div><div class="report-empty-title">NO DATA IN SELECTED RANGE</div><div class="report-empty-desc">No study sessions were logged between ${s} and ${e}.</div></div>`;
    return;
  }

  // Subject analytics for range blocks
  const rangeBlocks = allBlocks.filter(b=>b.date>=s&&b.date<=e);
  const subjectAnalytics = computeSubjectAnalytics(rangeBlocks);

  // Week heatmap: use last 7 days of range or full range week
  const rangeEnd = parseDate(e);
  const heatmapWeekDays = Array.from({length:7},(_,i)=>addDays(rangeEnd,-6+i));
  const matrixData = buildMatrixData(heatmapWeekDays, allBlocks);

  const rm=computeRangeMetrics(rangeLogs,allBlocks,allInts,allFatigue,s,e);
  const pm=computeRangeMetrics(prevLogs,allBlocks,allInts,allFatigue,prevStart,prevEnd);
  const cm=computeRangeMetrics(curLogs,allBlocks,allInts,allFatigue,'','');
  const lm=computeRangeMetrics(longTermLogs,allBlocks,allInts,allFatigue,'','');

  const out=el('reportOutput');
  out.innerHTML=buildReportHTML(rm,pm,cm,lm,rangeLogs,s,e,rangeLen,prevStart,prevEnd,subjectAnalytics,heatmapWeekDays,matrixData);

  requestAnimationFrame(()=>{
    drawMiniCanvas('mc-exec',rangeLogs.map(l=>l.execPct||0),'var(--accent)');
    drawMiniCanvas('mc-tests',rangeLogs.map(l=>l.totalTests||0),'var(--warn)');
    drawMiniCanvas('mc-hours',rangeLogs.map(l=>(l.completedSec||0)/3600),'var(--info)');
  });
}

function computeRangeMetrics(logs,blocks,ints,fatigue,s,e) {
  if(!logs.length) return null;
  const totalHrs=logs.reduce((a,l)=>a+(l.completedSec||0),0)/3600;
  const totalTests=logs.reduce((a,l)=>a+(l.totalTests||0),0);
  const avgDailyHrs=totalHrs/logs.length;
  const avgDailyTests=totalTests/logs.length;
  const avgExec=logs.reduce((a,l)=>a+(l.execPct||0),0)/logs.length;
  const avgPlanned=logs.reduce((a,l)=>a+(l.plannedHours||0),0)/logs.length;
  const testEff=totalHrs>0?totalTests/totalHrs:0;

  // Filter blocks/ints/fatigue to date range if s/e provided
  const rb=s&&e?blocks.filter(b=>b.date>=s&&b.date<=e):blocks;
  const ri=s&&e?ints.filter(i=>new Date(i.timestamp).toISOString().split('T')[0]>=s&&new Date(i.timestamp).toISOString().split('T')[0]<=e):ints;
  const rf=s&&e?fatigue.filter(f=>f.date>=s&&f.date<=e):fatigue;

  const intCount=ri.length;
  const avgFatigue=rf.length?rf.reduce((a,f)=>a+f.fatigue,0)/rf.length:null;
  const completedBlocks=rb.filter(b=>b.status==='completed').length;
  const totalBlocks=rb.length;

  // Most productive & interrupted hours
  const hourExec={},hourInt={};
  ri.forEach(i=>{const h=new Date(i.timestamp).getHours();hourInt[h]=(hourInt[h]||0)+1;});
  rb.filter(b=>b.startTime&&b.status==='completed').forEach(b=>{const h=parseInt(b.startTime.split(':')[0]);hourExec[h]=(hourExec[h]||0)+1;});
  const bestHour=Object.keys(hourExec).sort((a,b)=>hourExec[b]-hourExec[a])[0];
  const worstHour=Object.keys(hourInt).sort((a,b)=>hourInt[b]-hourInt[a])[0];

  // Tactical rating distribution
  const ratings={overloaded:0,heavy:0,balanced:0,light:0};
  logs.forEach(l=>{
    const hrs=l.plannedHours||0;
    if(hrs>12) ratings.overloaded++;
    else if(hrs>=8) ratings.heavy++;
    else if(hrs>=4) ratings.balanced++;
    else ratings.light++;
  });

  // Focus/Discipline/Momentum trends (check first vs last log)
  const execTrend=logs.length>1?(logs[logs.length-1].execPct||0)-(logs[0].execPct||0):0;

  return {totalHrs,totalTests,avgDailyHrs,avgDailyTests,avgExec,avgPlanned,testEff,intCount,avgFatigue,completedBlocks,totalBlocks,bestHour,worstHour,ratings,execTrend,days:logs.length};
}

function cmpArrow(current,prev,higher_is_better=true) {
  if(prev===null||current===null) return {arrow:'—',cls:'arrow-neutral',delta:null};
  const d=current-prev;
  const up=higher_is_better?d>=0:d<=0;
  return {
    arrow:Math.abs(d)<0.01?'—':up?'▲':'▼',
    cls:Math.abs(d)<0.01?'arrow-neutral':up?'arrow-up':'arrow-down',
    delta:d
  };
}

function buildReportHTML(rm,pm,cm,lm,rangeLogs,s,e,rangeLen,prevStart,prevEnd,subjectAnalytics,heatmapWeekDays,matrixData) {
  const prev=pm||null;
  const a=(c,p,hib=true)=>cmpArrow(c,p,hib);

  const execA=a(rm.avgExec,prev?.avgExec);
  const hrsA=a(rm.totalHrs,prev?.totalHrs);
  const testsA=a(rm.totalTests,prev?.totalTests);
  const effA=a(rm.testEff,prev?.testEff);
  const intA=a(rm.intCount,prev?.intCount,false);
  const fatA=a(rm.avgFatigue,prev?.avgFatigue,false);

  const fmt1=(n)=>n!==null&&n!==undefined?n.toFixed(1):'—';
  const fmt0=(n)=>n!==null&&n!==undefined?Math.round(n):'—';

  const statCards=[
    {label:'AVG EXECUTION',val:fmt0(rm.avgExec)+'%',arrow:execA,cmp:prev?fmt0(prev.avgExec)+'%':null,delay:0},
    {label:'TOTAL HOURS',val:fmt1(rm.totalHrs)+'h',arrow:hrsA,cmp:prev?fmt1(prev.totalHrs)+'h':null,delay:60},
    {label:'TOTAL TESTS',val:fmt0(rm.totalTests),arrow:testsA,cmp:prev?fmt0(prev.totalTests):null,delay:120},
    {label:'TEST EFFICIENCY',val:fmt1(rm.testEff)+'/hr',arrow:effA,cmp:prev?fmt1(prev.testEff)+'/hr':null,delay:180},
    {label:'AVG DAILY HOURS',val:fmt1(rm.avgDailyHrs)+'h',arrow:a(rm.avgDailyHrs,prev?.avgDailyHrs),cmp:prev?fmt1(prev.avgDailyHrs)+'h':null,delay:200},
    {label:'AVG DAILY TESTS',val:fmt0(rm.avgDailyTests),arrow:a(rm.avgDailyTests,prev?.avgDailyTests),cmp:prev?fmt0(prev.avgDailyTests):null,delay:220},
    {label:'INTERRUPTIONS',val:fmt0(rm.intCount),arrow:intA,cmp:prev?fmt0(prev.intCount):null,delay:240},
    {label:'AVG FATIGUE',val:rm.avgFatigue!==null?fmt0(rm.avgFatigue):'—',arrow:fatA,cmp:prev&&prev.avgFatigue!==null?fmt0(prev.avgFatigue):null,delay:260},
    {label:'BLOCKS COMPLETED',val:`${rm.completedBlocks}/${rm.totalBlocks}`,arrow:{arrow:'',cls:'arrow-neutral'},cmp:null,delay:280},
    {label:'DAYS LOGGED',val:rm.days,arrow:{arrow:'',cls:'arrow-neutral'},cmp:null,delay:300},
  ].map(c=>`<div class="report-stat-card" style="animation-delay:${c.delay}ms">
    <div class="report-stat-val">${c.val}</div>
    <div class="report-stat-label">${c.label}</div>
    ${c.arrow.arrow?`<div class="report-compare-arrow ${c.arrow.cls}">${c.arrow.arrow}</div>`:''}
    ${c.cmp?`<div class="report-compare-val">prev: ${c.cmp}${c.arrow.delta!==null?' ('+(c.arrow.delta>0?'+':'')+fmt1(c.arrow.delta)+')':''}</div>`:''}
  </div>`).join('');

  const ratingDist=`<div class="rating-distribution">
    ${rm.ratings.overloaded?`<span class="rating-pill overloaded">OVERLOADED ×${rm.ratings.overloaded}</span>`:''}
    ${rm.ratings.heavy?`<span class="rating-pill heavy">HEAVY ×${rm.ratings.heavy}</span>`:''}
    ${rm.ratings.balanced?`<span class="rating-pill balanced">BALANCED ×${rm.ratings.balanced}</span>`:''}
    ${rm.ratings.light?`<span class="rating-pill light">LIGHT ×${rm.ratings.light}</span>`:''}
  </div>`;

  // Subject analytics HTML
  let subjHTML = '';
  if (subjectAnalytics && subjectAnalytics.subjects.length > 0) {
    const cards = subjectAnalytics.subjects.map(s => {
      const col = subjectCatColor(s.name);
      const rtl = isRTL(s.name);
      return `<div class="subj-card" style="border-left-color:${col}">
        <div class="subj-card-name ${rtl?'':'ltr'}">${s.name}${s.dominance>50?'<span class="highlight-badge">DOMINANT</span>':''}</div>
        <div class="subj-card-stats">
          <div class="subj-stat"><div class="subj-stat-val" style="color:${col}">${s.hours.toFixed(1)}h</div><div class="subj-stat-label">hours</div></div>
          <div class="subj-stat"><div class="subj-stat-val" style="color:${col}">${s.tests}</div><div class="subj-stat-label">tests</div></div>
          <div class="subj-stat"><div class="subj-stat-val" style="color:${col}">${s.efficiency.toFixed(1)}</div><div class="subj-stat-label">eff/hr</div></div>
          <div class="subj-stat"><div class="subj-stat-val" style="color:${col}">${s.dominance.toFixed(0)}%</div><div class="subj-stat-label">dominance</div></div>
        </div>
        <div class="subj-dominance-bar"><div class="subj-dominance-fill" style="width:${s.dominance}%;background:${col}"></div></div>
      </div>`;
    }).join('');
    const neglectedBadges = subjectAnalytics.neglected.length
      ? subjectAnalytics.neglected.map(n=>`<span class="neglected-badge">${n}</span>`).join(' ')
      : '<span style="color:var(--success);font-size:10px">All matrix subjects active</span>';
    subjHTML = `
    <div class="report-section-title">SUBJECT INTELLIGENCE — ANALYTICS</div>
    <div class="subject-analytics-grid">${cards}</div>
    <div style="margin-top:12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <span style="font-size:9px;color:var(--text3);font-family:var(--font-mono);letter-spacing:1px">NEGLECTED / ABSENT:</span>
      ${neglectedBadges}
    </div>`;
  }

  // On-screen heatmap
  let heatmapHTML = '';
  if (heatmapWeekDays && matrixData) {
    // Find max cell value for scale
    let maxVal = 0;
    SUBJECT_MATRIX_LABELS.forEach(s => {
      heatmapWeekDays.forEach(d => {
        const v = matrixData[s]?.[dateStr(d)]?.hours||0;
        if (v > maxVal) maxVal = v;
      });
    });
    const heatLevel = (h) => {
      if (maxVal === 0 || h === 0) return 0;
      const r = h / maxVal;
      if (r < 0.1) return 0;
      if (r < 0.3) return 1;
      if (r < 0.55) return 2;
      if (r < 0.8) return 3;
      return 4;
    };
    const dayRow = heatmapWeekDays.map(d=>`<th>${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()]} ${d.getDate()}</th>`).join('');
    const rows = SUBJECT_MATRIX_LABELS.map(subj => {
      const cells = heatmapWeekDays.map(d=>{
        const ds = dateStr(d);
        const cell = matrixData[subj]?.[ds]||{hours:0,tests:0};
        const lvl = heatLevel(cell.hours);
        const disp = cell.hours>0?`${cell.hours.toFixed(1)}h / ${cell.tests}T`:'0h / 0T';
        return `<td class="heatmap-cell-${lvl}">${disp}</td>`;
      }).join('');
      return `<tr><td>${subj}</td>${cells}</tr>`;
    }).join('');
    heatmapHTML = `
    <div class="report-section-title">SUBJECT × DAY HEATMAP MATRIX (Last 7 Days of Range)</div>
    <div class="card" style="margin-bottom:16px">
      <div class="card-title"><span class="dot"></span>PERFORMANCE HEATMAP — intensity = study hours</div>
      <div class="heatmap-container">
        <table class="heatmap-table">
          <thead><tr><th>SUBJECT</th>${dayRow}</tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      <div class="text-muted mt-8">Scale: darker cells = more hours. Each cell shows Xh / YT (hours / tests).</div>
    </div>`;
  }

  const humanReport=buildHumanReport(rm,pm,cm,lm,s,e,rangeLen,subjectAnalytics,heatmapWeekDays,matrixData);

  return `
    <div class="report-section-title">SUMMARY STATISTICS — ${s} to ${e}</div>
    <div class="grid-5" style="margin-bottom:16px">${statCards}</div>

    <div class="grid-3" style="margin-bottom:16px">
      <div class="card">
        <div class="card-title"><span class="dot"></span>EXECUTION TREND</div>
        <div class="mini-canvas-wrap"><canvas id="mc-exec"></canvas></div>
        <div class="mini-canvas-label">Execution % · ${rangeLogs.length} days</div>
      </div>
      <div class="card">
        <div class="card-title"><span class="dot"></span>TEST VOLUME TREND</div>
        <div class="mini-canvas-wrap"><canvas id="mc-tests"></canvas></div>
        <div class="mini-canvas-label">Tests per day</div>
      </div>
      <div class="card">
        <div class="card-title"><span class="dot"></span>STUDY HOURS TREND</div>
        <div class="mini-canvas-wrap"><canvas id="mc-hours"></canvas></div>
        <div class="mini-canvas-label">Hours per day</div>
      </div>
    </div>

    <div class="grid-2" style="margin-bottom:8px">
      <div class="card">
        <div class="card-title"><span class="dot"></span>TACTICAL RATING DISTRIBUTION</div>
        ${ratingDist}
        <div class="text-muted mt-8">Based on ${rm.days} logged days in selected range</div>
      </div>
      <div class="card">
        <div class="card-title"><span class="dot"></span>TIME PATTERNS</div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <div><div style="font-size:10px;color:var(--text3);margin-bottom:3px">MOST PRODUCTIVE HOUR</div>
            <div class="font-mono" style="color:var(--accent);font-size:20px">${rm.bestHour!==undefined?rm.bestHour+':00':'—'}</div></div>
          <div><div style="font-size:10px;color:var(--text3);margin-bottom:3px">MOST INTERRUPTED HOUR</div>
            <div class="font-mono" style="color:var(--danger);font-size:20px">${rm.worstHour!==undefined?rm.worstHour+':00':'—'}</div></div>
        </div>
      </div>
    </div>

    ${subjHTML}
    ${heatmapHTML}

    ${humanReport}`;
}

function buildHumanReport(rm,pm,cm,lm,s,e,rangeLen,subjectAnalytics,heatmapWeekDays,matrixData) {
  // Generate four contextual paragraphs + subject paragraph
  const avgExec=Math.round(rm.avgExec);
  const prevAvgExec=pm?Math.round(pm.avgExec):null;
  const ltAvg=lm?Math.round(lm.avgExec):null;
  const testEff=rm.testEff.toFixed(1);
  const hrs=rm.totalHrs.toFixed(1);
  const tests=rm.totalTests;
  const days=rm.days;
  const rangeLabel=`${s} to ${e} (${days} days)`;

  // Paragraph 1: Performance summary
  let p1='';
  const execAdj=avgExec>=90?'exceptional':avgExec>=80?'commendable':avgExec>=65?'moderate':avgExec>=50?'underwhelming':'critically deficient';
  const hrsAdj=rm.avgDailyHrs>=8?'substantial':rm.avgDailyHrs>=5?'solid':rm.avgDailyHrs>=3?'moderate':'limited';
  p1=`Your performance during <em>${rangeLabel}</em> was <em>${execAdj}</em>, with an average execution rate of <em>${avgExec}%</em> across ${days} logged sessions. `;
  p1+=`Study volume totalled <em>${hrs} hours</em> (${hrsAdj} daily average of ${rm.avgDailyHrs.toFixed(1)}h) alongside <em>${tests} tests completed</em>, yielding a test efficiency of <em>${testEff} tests per hour</em>. `;
  if(avgExec>=85) p1+=`Block completion rate was high, indicating strong follow-through on planned sessions.`;
  else if(avgExec>=70) p1+=`Block completion was reasonable, though there remains headroom for improvement in converting planned sessions into completed work.`;
  else p1+=`Block completion was below standard—the gap between planned and actual output is the primary driver of reduced execution scores.`;

  // Paragraph 2: Comparison
  let p2='';
  if(!pm||pm.days===0){
    p2=`Comparative analysis against the prior equivalent period is unavailable due to insufficient historical data. As your log grows, this section will produce comparative intelligence.`;
  } else {
    const delta=avgExec-prevAvgExec;
    const hrsDelta=rm.totalHrs-pm.totalHrs;
    const testDelta=rm.totalTests-pm.totalTests;
    const dirExec=delta>0?`improved by ${delta} percentage points`:delta<0?`declined by ${Math.abs(delta)} percentage points`:`remained unchanged`;
    p2=`Compared to the equivalent preceding period, execution <em>${dirExec}</em> (${prevAvgExec}% → ${avgExec}%). `;
    if(Math.abs(hrsDelta)>=1) p2+=`Study volume ${hrsDelta>0?`increased by ${hrsDelta.toFixed(1)}h`:`decreased by ${Math.abs(hrsDelta).toFixed(1)}h`}. `;
    if(Math.abs(testDelta)>=5) p2+=`Test output ${testDelta>0?`rose by ${testDelta}`:`fell by ${Math.abs(testDelta)}`} tests. `;
    if(delta>=10) p2+=`This represents a meaningful upward shift—the trajectory is positive.`;
    else if(delta<=-10) p2+=`This negative shift is statistically significant and warrants a structured response, not incremental adjustment.`;
    else p2+=`The variation is within normal oscillation and does not indicate a structural change in performance.`;
    if(rm.intCount>pm.intCount) p2+=` Interruption frequency increased from ${pm.intCount} to ${rm.intCount}—a contributing factor worth examining.`;
  }
  if(ltAvg!==null&&lm.days>=14){
    const ltDiff=avgExec-ltAvg;
    if(ltDiff>=10) p2+=` In the broader context, this period performed <em>${ltDiff} points above</em> the long-term average of ${ltAvg}%, suggesting recovery or strategic improvement rather than a fortunate spike.`;
    else if(ltDiff<=-10) p2+=` Against a long-term average of <em>${ltAvg}%</em>, this period underperformed by ${Math.abs(ltDiff)} points—indicating a systemic issue rather than normal variance.`;
    else p2+=` Long-term baseline sits at <em>${ltAvg}%</em>, confirming this period reflects <em>sustained discipline</em> rather than isolated effort.`;
  }

  // Paragraph 3: Subject intelligence commentary
  let p3='';
  if (subjectAnalytics && subjectAnalytics.subjects.length > 0) {
    const top = subjectAnalytics.subjects[0];
    const dominated = top.dominance > 50;
    const bottom = subjectAnalytics.subjects[subjectAnalytics.subjects.length-1];
    p3 = `Subject distribution analysis reveals <em>${subjectAnalytics.subjects.length} active categories</em>. `;
    if (dominated) {
      p3 += `<em>${top.name}</em> dominates with ${top.dominance.toFixed(0)}% of total study hours (${top.hours.toFixed(1)}h)—this concentration risks leaving other subjects undertrained. `;
    } else {
      p3 += `<em>${top.name}</em> leads volume at ${top.hours.toFixed(1)}h (${top.dominance.toFixed(0)}%), with a reasonably distributed spread across subjects. `;
    }
    if (subjectAnalytics.neglected.length > 0) {
      p3 += `Critical gap: <em>${subjectAnalytics.neglected.join(', ')}</em> received zero logged hours during this period. These subjects carry hidden examination risk if left unaddressed. `;
    }
    if (top.efficiency > 10) {
      p3 += `Test efficiency in ${top.name} is ${top.efficiency.toFixed(1)}/hr—an excellent active-recall signature. `;
    } else if (top.efficiency < 3 && top.hours > 2) {
      p3 += `Despite leading in hours, ${top.name} efficiency is only ${top.efficiency.toFixed(1)}/hr—suggesting passive study patterns. Integrate active testing immediately. `;
    }
    // Heatmap pattern analysis
    if (matrixData && heatmapWeekDays) {
      let maxDay='', maxVal=0, emptyDays=0;
      heatmapWeekDays.forEach(d => {
        const ds=dateStr(d);
        const dayTotal = SUBJECT_MATRIX_LABELS.reduce((s,subj)=>(s+(matrixData[subj]?.[ds]?.hours||0)),0);
        if (dayTotal > maxVal) { maxVal=dayTotal; maxDay=fmtDateShort(d); }
        if (dayTotal === 0) emptyDays++;
      });
      if (emptyDays >= 2) p3 += `The heatmap shows <em>${emptyDays} days with no logged activity</em>—these gaps represent compressible time that could absorb neglected subjects. `;
      if (maxVal > 8) p3 += `A concentration spike occurred on <em>${maxDay}</em> (${maxVal.toFixed(1)}h)—single-day overloads reduce retention efficiency versus distributed study. `;
    }
  } else {
    p3 = `No subject data available for analysis in this range. Begin logging blocks with classified subjects to enable subject-intelligence commentary.`;
  }

  // Paragraph 4: Current state
  let p4='';
  const fatLabel=rm.avgFatigue!==null?(rm.avgFatigue>=60?'stable':rm.avgFatigue>=40?'elevated':rm.avgFatigue>=25?'warning-level':rm.avgFatigue>=15?'critically high':'in burnout territory'):'unassessed';
  p4=`Currently, your momentum stands at <em>${state.metrics.Momentum}</em> and focus at <em>${state.metrics.Focus}</em>. `;
  p4+=`Fatigue indicators over this period averaged <em>${rm.avgFatigue!==null?Math.round(rm.avgFatigue):'N/A'}</em>—reading as <em>${fatLabel}</em>. `;
  if(rm.avgFatigue!==null&&rm.avgFatigue<40) p4+=`Continued high-volume work without recovery carries compounding risk. `;
  if(rm.intCount>rm.days*1.5) p4+=`Interruption rate of ${(rm.intCount/rm.days).toFixed(1)} per day is abnormally high and is likely suppressing both focus and execution scores. `;
  if(rm.execTrend>10) p4+=`Execution was trending upward across the period—a positive signal.`;
  else if(rm.execTrend<-10) p4+=`Execution was trending downward across the period, which requires attention before it compounds further.`;
  else p4+=`Execution was broadly stable across the period with no significant directional trend.`;

  // Paragraph 5: Strategic advice
  let p5='';
  if(rm.totalHrs>5&&rm.testEff<3) {
    p5+=`The primary strategic opportunity is <em>test density</em>. With ${hrs}h of study and only ${testEff} tests/hr, significant time is allocated to passive reading or review. Implement spaced-repetition testing within every session—target a minimum of 8–10 tests per hour. `;
  } else if(rm.totalTests>10&&rm.totalHrs<3) {
    p5+=`Test throughput is relatively high, but study depth is limited at ${hrs} hours. Extend individual block durations to allow deeper conceptual engagement alongside the active recall. `;
  } else if(rm.totalHrs>=5&&rm.testEff>=8) {
    p5+=`The balance between study volume and test density is effective. Reinforce this pattern—it represents the dual-metric performance signature of high-performing learners. `;
  }
  if(state.mission){
    const dL=Math.max(1,Math.ceil((new Date(state.mission.targetDate)-new Date())/86400000));
    const allL=lm?lm.totalHrs:rm.totalHrs;
    const remH=Math.max(0,state.mission.requiredHours-allL);
    const nH=remH/dL;
    if(nH>rm.avgDailyHrs*1.2) p5+=`Mission deadline analysis projects a daily requirement of <em>${nH.toFixed(1)}h</em> versus your recent average of <em>${rm.avgDailyHrs.toFixed(1)}h/day</em>. Close this gap through session front-loading and eliminating dead time between blocks. `;
    else p5+=`Current daily output is on a trajectory to satisfy mission requirements. Maintain consistency and avoid schedule disruptions in the critical final period. `;
  }
  if(avgExec<70) p5+=`Priority action: do not add more planned hours—first restore completion rate on current volume. Over-planning against under-executing creates compounding psychological debt.`;
  else if(avgExec>=85&&rm.avgDailyHrs<6) p5+=`You are executing well—the next lever is volume. A conservative increase of 1–1.5h per day, applied consistently, would materially accelerate mission progress.`;
  else p5+=`Continue current strategy. The highest-return action is <em>consistency</em>—maintaining this execution level across the next 14 days will compound into measurable mission progress.`;

  return `<div class="human-report">
    <div class="human-report-header">
      <div class="human-report-icon">◈</div>
      <div>
        <div class="human-report-title">ADVISOR ASSESSMENT</div>
        <div class="human-report-subtitle">Generated from ${rm.days}-day analysis · ${new Date().toLocaleString()}</div>
      </div>
    </div>
    <div class="report-paragraph p-summary">
      <span class="report-paragraph-tag">01 · PERFORMANCE SUMMARY</span>
      ${p1}
    </div>
    <div class="report-paragraph p-comparison">
      <span class="report-paragraph-tag">02 · COMPARATIVE ANALYSIS</span>
      ${p2}
    </div>
    <div class="report-paragraph p-assessment">
      <span class="report-paragraph-tag">03 · SUBJECT INTELLIGENCE & HEATMAP PATTERNS</span>
      ${p3}
    </div>
    <div class="report-paragraph p-assessment" style="border-left-color:var(--warn)">
      <span class="report-paragraph-tag">04 · CURRENT STATE ASSESSMENT</span>
      ${p4}
    </div>
    <div class="report-paragraph p-strategy">
      <span class="report-paragraph-tag">05 · STRATEGIC DIRECTION</span>
      ${p5}
    </div>
  </div>`;
}

// mini canvas spark line
function drawMiniCanvas(id,data,color) {
  const canvas=el(id);
  if(!canvas||!data.length) return;
  const dpr=window.devicePixelRatio||1;
  const W=canvas.offsetWidth||200,H=60;
  canvas.width=W*dpr; canvas.height=H*dpr;
  canvas.style.width=W+'px'; canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  const max=Math.max(...data,0.01),min=0;
  const pad=4;
  const step=data.length>1?(W-pad*2)/(data.length-1):0;
  ctx.clearRect(0,0,W,H);
  // Fill
  ctx.beginPath();
  ctx.moveTo(pad,(H-pad)-(((data[0]-min)/(max-min))*(H-pad*2)));
  data.forEach((v,i)=>{const x=pad+i*step;const y=(H-pad)-(((v-min)/(max-min))*(H-pad*2));ctx.lineTo(x,y);});
  ctx.lineTo(pad+step*(data.length-1),H-pad);ctx.lineTo(pad,H-pad);ctx.closePath();
  const grad=ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,color.replace('var(','')+')');
  ctx.fillStyle=grad;
  // Solid area fill with transparency approach
  ctx.globalAlpha=0.15; ctx.fill(); ctx.globalAlpha=1;
  // Line
  ctx.beginPath();
  data.forEach((v,i)=>{const x=pad+i*step;const y=(H-pad)-(((v-min)/(max-min))*(H-pad*2));i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.strokeStyle=color.includes('var')? getCSSVar(color):color;
  ctx.lineWidth=1.5; ctx.stroke();
  // Dots
  data.forEach((v,i)=>{
    const x=pad+i*step;const y=(H-pad)-(((v-min)/(max-min))*(H-pad*2));
    ctx.beginPath();ctx.arc(x,y,2,0,Math.PI*2);
    ctx.fillStyle=ctx.strokeStyle; ctx.fill();
  });
}
function getCSSVar(v) {
  const name=v.replace('var(','').replace(')','').trim();
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim()||'#00ff88';
}

// ================================================================
// PLANNED HOURS / TARGETS
// ================================================================
async function loadTodayLog() {
  const log=await dbGet('dailyLogs',today());
  // CLEAN START: no default hours
  state.todayLog=log||{date:today(),plannedHours:0,dailyTestTarget:0,weeklyTestTarget:0};
  const ph=el('plannedHoursInput');
  const dt=el('dailyTestTarget');
  const wt=el('weeklyTestTarget');
  if(ph) ph.value=state.todayLog.plannedHours||'';
  if(dt) dt.value=state.todayLog.dailyTestTarget||'';
  if(wt) wt.value=state.todayLog.weeklyTestTarget||'';
}
async function savePlannedHours() {
  const ph=parseFloat(el('plannedHoursInput').value)||0;
  const dt=parseInt(el('dailyTestTarget').value)||0;
  const wt=parseInt(el('weeklyTestTarget').value)||0;
  state.todayLog=state.todayLog||{date:today()};
  state.todayLog.plannedHours=ph;
  state.todayLog.dailyTestTarget=dt;
  state.todayLog.weeklyTestTarget=wt;
  await dbPut('dailyLogs',state.todayLog);
  await calculateTodayExecution();
  showToast(`Targets set: ${ph}h planned, ${dt} tests/day`);
}

// ================================================================
// THEME ENGINE
// ================================================================
async function loadTheme() { const t=await dbGet('themes','active'); if(t) setTheme(t.name,false); }
async function setTheme(name,save=true) {
  document.body.className=document.body.className.replace(/theme-\w+/g,'').trim();
  if(name==='midnight') document.body.classList.add('theme-midnight');
  else if(name==='graphite') document.body.classList.add('theme-graphite');
  state.theme=name;
  document.querySelectorAll('.theme-btn').forEach(b=>b.classList.remove('active'));
  const btn=el('theme-'+name); if(btn) btn.classList.add('active');
  if(save) await dbPut('themes',{id:'active',name});
}

// ================================================================
// BACKUP
// ================================================================
async function exportBackup() {
  const stores=['dailyLogs','studyBlocks','metrics','habits','streaks','performanceHistory','mission','themes','interruptions','fatigueHistory'];
  const data={};
  for(const s of stores) data[s]=await dbGetAll(s);
  data.exportDate=today(); data.version=DB_VERSION;
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`execution-backup-${today()}.json`;a.click();
  URL.revokeObjectURL(url);
  await dbPut('themes',{id:'lastBackup',name:today()});
  setText('lastBackupInfo','Last backup: '+today());
  el('backupBanner').classList.remove('active');
  showToast('Backup exported.');
}
async function importBackup(event) {
  const file=event.target.files[0];if(!file) return;
  const reader=new FileReader();
  reader.onload=async e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(!data.dailyLogs||!data.studyBlocks) throw new Error('Invalid structure');
      showConfirm('RESTORE BACKUP',`Overwrite all data with backup from ${data.exportDate||'unknown date'}?`,async()=>{
        const stores=['dailyLogs','studyBlocks','metrics','habits','streaks','performanceHistory','mission','themes','interruptions','fatigueHistory'];
        for(const s of stores){await dbClear(s);if(data[s]) for(const item of data[s]) await dbPut(s,item);}
        showToast('Backup restored. Reloading...');
        setTimeout(()=>location.reload(),1500);
      });
    }catch(err){alert('Invalid backup: '+err.message);}
  };
  reader.readAsText(file);
  event.target.value='';
}
async function checkBackupReminder() {
  const last=await dbGet('themes','lastBackup');
  if(!last){el('backupBanner').classList.add('active');return;}
  const days=(new Date()-new Date(last.name))/86400000;
  if(days>=3) el('backupBanner').classList.add('active');
  setText('lastBackupInfo','Last backup: '+last.name);
}

// ================================================================
// DASHBOARD RENDER
// ================================================================
async function renderDashboard() {
  renderAllMetrics();
  await updateStreaks();
  await updateRank();
  await renderPerfBars();
  await calculateFatigue();
  await calculateTodayExecution();
  await updateMissionPressure();
  await checkCommandMode();
}

// ================================================================
// UI HELPERS
// ================================================================
function switchView(name,btn) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  el('view-'+name).classList.add('active');
  if(btn) btn.classList.add('active');
  state.currentView=name;
  if(name==='blocks') renderBlocks();
  if(name==='calendar') renderCalendar();
  if(name==='advisor') generateAdvisory();
  if(name==='habits') renderHabits();
  if(name==='mission') updateMissionPressure();
  if(name==='dashboard') renderDashboard();
  if(name==='journal') initJournalView();
}
function openModal(id){el(id).classList.add('active');}
function closeModal(id){el(id).classList.remove('active');}
let confirmCallback=null;
function showConfirm(title,text,cb) {
  setText('confirmTitle',title);setText('confirmText',text);
  confirmCallback=cb;
  el('confirmOkBtn').onclick=()=>{closeModal('confirmModal');if(confirmCallback) confirmCallback();};
  openModal('confirmModal');
}
function confirmReset() {
  showConfirm('RESET ALL DATA','This permanently erases all stored data. Cannot be undone.',async()=>{
    const stores=['dailyLogs','studyBlocks','metrics','habits','streaks','performanceHistory','mission','themes','interruptions','fatigueHistory'];
    for(const s of stores) await dbClear(s);
    showToast('All data erased. Reloading...');
    setTimeout(()=>location.reload(),1500);
  });
}
function showToast(msg) {
  const t=document.createElement('div');
  t.style.cssText='position:fixed;bottom:20px;right:20px;background:var(--bg3);border:1px solid var(--border2);color:var(--text);padding:10px 16px;border-radius:var(--radius);font-size:11px;font-family:var(--font-mono);z-index:999;animation:msgFade 0.2s ease;max-width:340px;box-shadow:0 4px 20px rgba(0,0,0,0.5)';
  t.textContent=msg; document.body.appendChild(t);
  setTimeout(()=>t.remove(),3000);
}
document.querySelectorAll('.modal-overlay').forEach(o=>{ o.addEventListener('click',e=>{if(e.target===o) o.classList.remove('active');}); });

// ================================================================
// BREAK TIMER CHECK
// ================================================================
let lastActivity=Date.now();
setInterval(async()=>{
  const paused=state.blocks.filter(b=>b.status==='paused'&&b.date===today());
  if(paused.length>0){
    const idle=(Date.now()-lastActivity)/60000;
    if(idle>15){await adjustMetric('Focus',-3);showToast('Extended break detected — Focus -3');lastActivity=Date.now();}
  }
},60000);
document.addEventListener('click',()=>{lastActivity=Date.now();});
document.addEventListener('keydown',()=>{lastActivity=Date.now();});

// ================================================================
// JOURNAL PDF EXPORT ENGINE — v3
// Operational Daily PDF, Operational Weekly Single-Page PDF (8×9 heatmap),
// Full Analytical PDF. Pure offline Canvas→JPEG→PDF. No external libs.
// ================================================================

const journalState = {
  mode: 'day',
  pdfTheme: 'light',
  dayDate: today(),
  weekRefDate: today(),
  weekStartDay: 1,
};

function initJournalView() {
  if (!el('jrnlDayDate').value) el('jrnlDayDate').value = today();
  if (!el('jrnlWeekRefDate').value) el('jrnlWeekRefDate').value = today();
  updateJournalPreview();
}
function setJournalMode(m) {
  journalState.mode = m;
  ['day','week'].forEach(k => el('jm-'+k).classList.toggle('active', k === m));
  el('jrnlDayOpts').style.display  = m === 'day'  ? '' : 'none';
  el('jrnlWeekOpts').style.display = m === 'week' ? '' : 'none';
  updateJournalPreview();
}
function setJournalPdfTheme(t) {
  journalState.pdfTheme = t;
  ['dark','light'].forEach(k => el('jpt-'+k).classList.toggle('active', k === t));
}
function updateJournalPreview() {
  journalState.dayDate     = el('jrnlDayDate').value || today();
  journalState.weekRefDate = el('jrnlWeekRefDate').value || today();
  journalState.weekStartDay = parseInt(el('jrnlWeekStartDay').value);

  if (journalState.mode === 'day') {
    const blocks = state.blocks.filter(b => b.date === journalState.dayDate);
    el('jrnlPageCount').textContent = '1 PAGE';
    el('jrnlPageList').innerHTML = `
      <div class="jrnl-page-item">
        <span class="jrnl-page-num">P.01</span>
        <span class="jrnl-page-desc">${fmtDateFull(parseDate(journalState.dayDate))} — Operational Daily Journal</span>
        <span class="jrnl-page-blocks">${blocks.length} block${blocks.length!==1?'s':''}</span>
      </div>`;
  } else {
    const days = getWeekDays(journalState.weekRefDate, journalState.weekStartDay);
    el('jrnlWeekRangeLabel').textContent = `Week: ${fmtDateShort(days[0])} → ${fmtDateShort(days[6])}`;
    el('jrnlPageCount').textContent = '1 PAGE';
    el('jrnlPageList').innerHTML = `
      <div class="jrnl-page-item">
        <span class="jrnl-page-num">P.01</span>
        <span class="jrnl-page-desc">Weekly Operational Summary + 8×9 Heatmap Matrix (${fmtDateShort(days[0])} – ${fmtDateShort(days[6])})</span>
        <span class="jrnl-page-blocks" style="color:var(--warn)">MATRIX</span>
      </div>`;
  }
}

// --- Date helpers ---
function fmtDateFull(d) {
  if (!(d instanceof Date)) d = parseDate(d);
  return ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][d.getDay()]
    + ', ' + monthNames[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
}
function fmtDateShort(d) {
  if (!(d instanceof Date)) d = parseDate(d);
  return monthNames[d.getMonth()].slice(0,3) + ' ' + d.getDate();
}
function getWeekDays(refDateStr, startDay) {
  const ref = parseDate(refDateStr);
  const dow = ref.getDay();
  let delta = (dow - startDay + 7) % 7;
  const start = addDays(ref, -delta);
  return Array.from({length:7}, (_,i) => addDays(start, i));
}

// --- PDF Theme palettes ---
function getJournalPalette(pdfTheme) {
  const appAccent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#00ff88';
  if (pdfTheme === 'dark') {
    return { bg:'#0f0f0f',surface:'#1a1a1a',border:'#2c2c2c',border2:'#3a3a3a',text:'#e8e8e8',textDim:'#777',textLight:'#444',accent:appAccent,headerBg:'#000',headerText:appAccent,tableBg:'#0f0f0f',tableAlt:'#141414',tableHead:'#1a1a1a',heatLow:'rgba(0,221,204,',heatHigh:appAccent };
  }
  return { bg:'#ffffff',surface:'#f4f4f4',border:'#d8d8d8',border2:'#c0c0c0',text:'#1a1a1a',textDim:'#666',textLight:'#999',accent:'#1a5e38',headerBg:'#1a1a1a',headerText:'#ffffff',tableBg:'#ffffff',tableAlt:'#f7f7f7',tableHead:'#1a1a1a',heatLow:'rgba(37,99,235,',heatHigh:'#1d4ed8' };
}

// --- Canvas page dimensions (A4 @ ~118dpi) ---
const PDF_W = 992, PDF_H = 1403, M = 52, CW = 992 - 104;

function makeCanvas(W,H) { const c=document.createElement('canvas');c.width=W;c.height=H;return c; }
function canvasToJpeg(canvas,q) {
  return new Promise(r=>{canvas.toBlob(b=>{const rd=new FileReader();rd.onload=()=>r(rd.result);rd.readAsDataURL(b);},'image/jpeg',q||0.93);});
}
function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}
function truncStr(s,maxPx,ctx){if(!s)return'';let t=s;while(t.length>0&&ctx.measureText(t).width>maxPx)t=t.slice(0,-1);if(t.length<s.length)t=t.slice(0,-1)+'…';return t;}

function drawPageHeader(ctx,P,pageLabel,dateLabel,pageNum,totalPages){
  ctx.fillStyle=P.headerBg;ctx.fillRect(0,0,PDF_W,88);
  ctx.fillStyle=P.accent;ctx.fillRect(0,0,5,88);
  ctx.fillStyle=P.headerText;ctx.font='bold 13px monospace';ctx.textAlign='left';ctx.fillText('EXECUTION ENGINE',M,32);
  ctx.fillStyle=P.textLight;ctx.font='9px monospace';ctx.fillText('TACTICAL ADVISOR EDITION · PLANNING JOURNAL',M,50);ctx.fillText('GENERATED: '+new Date().toLocaleDateString('en-GB'),M,66);
  ctx.textAlign='right';ctx.fillStyle=P.headerText;ctx.font='bold 15px monospace';ctx.fillText(dateLabel,PDF_W-M,35);
  ctx.fillStyle=P.textDim;ctx.font='9px monospace';ctx.fillText(pageLabel.toUpperCase(),PDF_W-M,52);ctx.fillText('PAGE '+pageNum+' / '+totalPages,PDF_W-M,68);ctx.textAlign='left';
}
function drawPageFooter(ctx,P,label){
  const y=PDF_H-36;ctx.fillStyle=P.border;ctx.fillRect(M,y,CW,1);
  ctx.fillStyle=P.textLight;ctx.font='8px monospace';ctx.fillText('EXECUTION ENGINE · TACTICAL ADVISOR EDITION',M,y+16);
  ctx.textAlign='right';ctx.fillStyle=P.accent;ctx.fillText(label||'',PDF_W-M,y+16);ctx.textAlign='left';
}
function drawStatBox(ctx,P,x,y,w,h,label,value,r){
  ctx.fillStyle=P.surface;roundRect(ctx,x,y,w,h,r||3);ctx.fill();
  ctx.strokeStyle=P.border;ctx.lineWidth=1;roundRect(ctx,x,y,w,h,r||3);ctx.stroke();
  ctx.fillStyle=P.accent;ctx.fillRect(x,y,w,3);
  ctx.fillStyle=P.text;ctx.font='bold 18px monospace';ctx.fillText(String(value),x+12,y+38);
  ctx.fillStyle=P.textDim;ctx.font='7.5px monospace';ctx.fillText(label,x+12,y+56);
}

// --- Operational DAILY PDF ---
async function renderDayPageToJpeg(dateObj, blocks, log, mission, fatigueIdx, pdfTheme) {
  const P = getJournalPalette(pdfTheme);
  const canvas = makeCanvas(PDF_W, PDF_H);
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = P.bg; ctx.fillRect(0,0,PDF_W,PDF_H);

  drawPageHeader(ctx,P,'OPERATIONAL DAILY JOURNAL',fmtDateFull(dateObj),1,1);

  // Stats row
  const statH=72,statGap=12,statW=Math.floor((CW-statGap*3)/4);
  const planH = log?.plannedHours||0;
  const totTests = blocks.reduce((s,b)=>s+(b.tests||0),0);
  const compTests = blocks.reduce((s,b)=>s+(b.completedTests||0),0);
  const execPct = log?.execPct||0;
  const fatLabel = fatigueIdx===null?'—':fatigueIdx>=60?'STABLE':fatigueIdx>=40?'ELEVATED':fatigueIdx>=25?'WARNING':'CRITICAL';
  const missionStr = mission?Math.max(0,Math.ceil((new Date(mission.targetDate)-new Date())/86400000))+'d left':'NO MISSION';
  const tactLoad = planH>10?'OVERLOAD':planH>=7?'HEAVY':planH>=4?'BALANCED':'LIGHT';
  [
    {label:'PLANNED HOURS',value:planH>0?planH+'h':'—'},
    {label:'TEST TARGET',value:totTests>0?String(totTests):'—'},
    {label:'EXECUTION %',value:execPct>0?execPct+'%':'—'},
    {label:'FATIGUE / LOAD',value:fatLabel+' / '+tactLoad},
  ].forEach((s,i)=>drawStatBox(ctx,P,M+i*(statW+statGap),104,statW,statH,s.label,s.value,4));

  // Subject breakdown
  const sa = computeSubjectAnalytics(blocks);
  let sby = 104+statH+16;
  if(sa.subjects.length>0){
    ctx.fillStyle=P.textDim;ctx.font='bold 7.5px monospace';ctx.fillText('SUBJECT BREAKDOWN',M,sby);
    ctx.fillStyle=P.border;ctx.fillRect(M,sby+2,CW,1);
    sby+=12;
    const sbW=Math.floor((CW-8*(sa.subjects.length-1))/Math.min(sa.subjects.length,6));
    sa.subjects.slice(0,6).forEach((s,i)=>{
      const sx=M+i*(sbW+8),sy2=sby;
      ctx.fillStyle=P.surface;ctx.fillRect(sx,sy2,sbW,40);
      ctx.strokeStyle=P.border;ctx.lineWidth=1;ctx.strokeRect(sx,sy2,sbW,40);
      ctx.fillStyle=subjectCatColor(s.name);ctx.fillRect(sx,sy2,sbW,3);
      ctx.fillStyle=P.text;ctx.font='bold 8px monospace';ctx.fillText(truncStr(s.name,sbW-8,ctx),sx+4,sy2+16);
      ctx.fillStyle=P.textDim;ctx.font='7px monospace';ctx.fillText(s.hours.toFixed(1)+'h / '+s.tests+'T',sx+4,sy2+28);
    });
    sby+=52;
  }

  // Compact advisory
  const missions = state.mission;
  let advisoryLines = [];
  if(execPct>=85) advisoryLines.push('Strong execution today. Maintain momentum into tomorrow.');
  else if(execPct>=60) advisoryLines.push('Moderate execution. Review incomplete blocks for rescheduling.');
  else if(execPct>0) advisoryLines.push('Execution below threshold. Identify and remove the primary friction source.');
  else advisoryLines.push('No execution logged yet. Begin with highest-priority block.');
  if(fatigueIdx!==null&&fatigueIdx<40) advisoryLines.push('Fatigue alert: reduce late sessions and ensure 7+ hours sleep tonight.');
  if(mission){const dL=Math.max(1,Math.ceil((new Date(mission.targetDate)-new Date())/86400000));const nH=(mission.requiredHours-((log?.completedSec||0)/3600))/dL;if(nH>0) advisoryLines.push(`Mission requires ~${nH.toFixed(1)}h/day to deadline.`);}
  if(sa.neglected.length>0) advisoryLines.push('Neglected: '+sa.neglected.slice(0,3).join(', ')+'—schedule recovery blocks.');

  const advY = sby;
  ctx.fillStyle=P.surface;ctx.fillRect(M,advY,CW,Math.min(4,advisoryLines.length)*14+14);
  ctx.strokeStyle=P.border;ctx.lineWidth=1;ctx.strokeRect(M,advY,CW,Math.min(4,advisoryLines.length)*14+14);
  ctx.fillStyle=P.accent;ctx.fillRect(M,advY,3,Math.min(4,advisoryLines.length)*14+14);
  ctx.fillStyle=P.textDim;ctx.font='bold 7px monospace';ctx.fillText('ADVISORY SUMMARY',M+8,advY+10);
  advisoryLines.slice(0,4).forEach((line,i)=>{
    ctx.fillStyle=P.text;ctx.font='7.5px monospace';ctx.fillText(truncStr(line,CW-20,ctx),M+8,advY+22+i*14);
  });

  // To-Do Table
  const tableStartY = advY + Math.min(4,advisoryLines.length)*14+14+16;
  const cols=[
    {label:'SUBJECT',w:Math.round(CW*0.20)},
    {label:'OBJECT / TOPIC',w:Math.round(CW*0.22)},
    {label:'DURATION',w:Math.round(CW*0.10)},
    {label:'TESTS',w:Math.round(CW*0.08)},
    {label:'PRIORITY',w:Math.round(CW*0.09)},
    {label:'STATUS',w:Math.round(CW*0.09)},
    {label:'NOTES',w:CW-Math.round(CW*0.20)-Math.round(CW*0.22)-Math.round(CW*0.10)-Math.round(CW*0.08)-Math.round(CW*0.09)-Math.round(CW*0.09)},
  ];
  const rowH=38,headH=24;
  const maxRows=Math.floor((PDF_H-tableStartY-60-headH)/rowH);
  const emptyRows=Math.max(0,maxRows-blocks.length);
  const allRows=[...blocks,...Array(emptyRows).fill(null)];
  ctx.fillStyle=P.textDim;ctx.font='bold 7.5px monospace';ctx.fillText('SESSION PLANNING TABLE',M,tableStartY-4);
  let ty=tableStartY;
  // Header
  ctx.fillStyle=P.tableHead;ctx.fillRect(M,ty,CW,headH);
  let cx=M;
  cols.forEach((col,i)=>{
    if(i>0){ctx.strokeStyle=P.border;ctx.lineWidth=0.5;ctx.beginPath();ctx.moveTo(cx,ty);ctx.lineTo(cx,ty+headH);ctx.stroke();}
    ctx.fillStyle=journalState.pdfTheme==='dark'?P.accent:'#ffffff';ctx.font='bold 7px monospace';ctx.fillText(col.label,cx+4,ty+16);
    cx+=col.w;
  });
  ctx.strokeStyle=P.border;ctx.lineWidth=1;ctx.strokeRect(M,ty,CW,headH);
  ty+=headH;
  allRows.slice(0,maxRows).forEach((block,ri)=>{
    ctx.fillStyle=ri%2===0?P.tableBg:P.tableAlt;ctx.fillRect(M,ty,CW,rowH);
    ctx.strokeStyle=P.border;ctx.lineWidth=0.5;ctx.strokeRect(M,ty,CW,rowH);
    let cx2=M;
    cols.forEach((col,ci)=>{
      if(ci>0){ctx.strokeStyle=P.border;ctx.lineWidth=0.5;ctx.beginPath();ctx.moveTo(cx2,ty);ctx.lineTo(cx2,ty+rowH);ctx.stroke();}
      if(block){
        const score=(block.tests||0)*2+(block.duration||0)/30;
        const pri=score>=8?'HIGH':score>=4?'MED':'LOW';
        let val='';
        if(ci===0){ctx.fillStyle=P.text;ctx.font='bold 8px monospace';val=truncStr(block.subject||'',col.w-8,ctx);}
        else if(ci===1){ctx.fillStyle=P.textDim;ctx.font='7.5px monospace';val=truncStr(block.blockObject||'',col.w-8,ctx);}
        else if(ci===2){ctx.fillStyle=P.text;ctx.font='8px monospace';val=(block.duration||0)+'m';}
        else if(ci===3){ctx.fillStyle=P.text;ctx.font='8px monospace';val=String(block.tests||0);}
        else if(ci===4){ctx.fillStyle=score>=8?'#e05555':score>=4?'#e0a040':P.textDim;ctx.font='bold 7.5px monospace';val=pri;}
        else if(ci===5){
          const done=block.status==='completed';
          const bx=cx2+(col.w-14)/2,by=ty+(rowH-14)/2;
          ctx.strokeStyle=P.border2;ctx.lineWidth=1.5;ctx.strokeRect(bx,by,14,14);
          if(done){ctx.strokeStyle=P.accent;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(bx+2,by+7);ctx.lineTo(bx+5,by+11);ctx.lineTo(bx+12,by+3);ctx.stroke();}
          val='';
        }
        if(val){ctx.fillText(val,cx2+4,ty+rowH*0.62);}
        if(ci===0&&block.startTime){ctx.fillStyle=P.textDim;ctx.font='6.5px monospace';ctx.fillText(block.startTime,cx2+4,ty+rowH-6);}
      }
      ctx.fillStyle=P.text;cx2+=col.w;
    });
    ty+=rowH;
  });
  ctx.strokeStyle=P.border2;ctx.lineWidth=1.5;ctx.strokeRect(M,tableStartY,CW,headH+(Math.min(allRows.length,maxRows))*rowH);

  drawPageFooter(ctx,P,fmtDateFull(dateObj).toUpperCase());
  return canvasToJpeg(canvas,0.92);
}

// --- Operational WEEKLY PDF (ONE single A4 page) ---
async function renderWeeklyOpsPageToJpeg(weekDays, allBlocks, allLogs, mission, pdfTheme) {
  const P = getJournalPalette(pdfTheme);
  const canvas = makeCanvas(PDF_W, PDF_H);
  const ctx = canvas.getContext('2d');
  ctx.fillStyle=P.bg;ctx.fillRect(0,0,PDF_W,PDF_H);

  const firstDate=weekDays[0],lastDate=weekDays[6];
  drawPageHeader(ctx,P,'OPERATIONAL WEEKLY SUMMARY',`${fmtDateShort(firstDate)} – ${fmtDateShort(lastDate)}`,1,1);

  // Weekly summary stats
  const weekLogs=weekDays.map(d=>allLogs.find(l=>l.date===dateStr(d))||null);
  const totH=weekLogs.reduce((s,l)=>s+(l?.completedSec||0)/3600,0);
  const totT=weekLogs.reduce((s,l)=>s+(l?.totalTests||0),0);
  const avgExec=weekLogs.filter(Boolean).length?Math.round(weekLogs.filter(Boolean).reduce((s,l)=>s+(l.execPct||0),0)/weekLogs.filter(Boolean).length):0;
  const totBlocks=weekDays.reduce((s,d)=>s+allBlocks.filter(b=>b.date===dateStr(d)).length,0);
  const planHWeek=weekLogs.reduce((s,l)=>s+(l?.plannedHours||0),0);
  const testEff=totH>0?totT/totH:0;

  const sumH=62,sumGap=10,sumW=Math.floor((CW-sumGap*4)/5);
  [{label:'TOTAL HOURS',value:totH.toFixed(1)+'h'},{label:'TOTAL TESTS',value:String(totT)},{label:'AVG EXECUTION',value:avgExec+'%'},{label:'TEST EFF',value:testEff.toFixed(1)+'/hr'},{label:'BLOCKS',value:String(totBlocks)}]
    .forEach((s,i)=>drawStatBox(ctx,P,M+i*(sumW+sumGap),104,sumW,sumH,s.label,s.value,3));

  // Advisory note (overload / underload)
  const recentCap=weekLogs.filter(Boolean).length?weekLogs.filter(Boolean).reduce((s,l)=>s+(l.completedSec||0)/3600,0)/weekLogs.filter(Boolean).length:4;
  let advisory='';
  if(planHWeek>recentCap*7*1.2&&planHWeek>0) advisory='⚠ Weekly load exceeds realistic capacity. Consider redistributing across sessions.';
  else if(planHWeek>0&&planHWeek<recentCap*7*0.6) advisory='◦ Available capacity remains underutilised. Review mission targets.';
  else if(avgExec>=80) advisory='✓ Execution on target. Maintain current rhythm through the coming week.';
  else if(avgExec<60) advisory='⚠ Execution below threshold. Focus on block completion before adding volume.';

  // Executive summary (6-8 lines)
  const execLines=[
    `Week of ${fmtDateShort(firstDate)} – ${fmtDateShort(lastDate)}`,
    `Total: ${totH.toFixed(1)}h · ${totT} tests · ${avgExec}% avg execution`,
    `Test efficiency: ${testEff.toFixed(1)} tests/hr · ${totBlocks} blocks logged`,
    planHWeek>0?`Planned: ${planHWeek.toFixed(1)}h | Actual: ${totH.toFixed(1)}h`:'No planned hours set.',
    advisory,
    mission?`Mission: ${Math.max(0,Math.ceil((new Date(mission.targetDate)-new Date())/86400000))}d remaining | ${Math.max(0,(mission.requiredHours-totH)).toFixed(0)}h outstanding`:'No active mission.',
  ].filter(Boolean);

  const execBoxY=104+sumH+12;
  ctx.fillStyle=P.surface;ctx.fillRect(M,execBoxY,CW,execLines.length*14+16);
  ctx.strokeStyle=P.border;ctx.lineWidth=1;ctx.strokeRect(M,execBoxY,CW,execLines.length*14+16);
  ctx.fillStyle=P.accent;ctx.fillRect(M,execBoxY,3,execLines.length*14+16);
  ctx.fillStyle=P.textDim;ctx.font='bold 7px monospace';ctx.fillText('EXECUTIVE SUMMARY',M+8,execBoxY+10);
  execLines.forEach((line,i)=>{
    ctx.fillStyle=P.text;ctx.font='8px monospace';ctx.fillText(truncStr(line,CW-20,ctx),M+8,execBoxY+22+i*14);
  });

  // Mini performance bar chart (execution per day)
  const chartY=execBoxY+execLines.length*14+16+20;
  const chartH=80;const barW=Math.floor((CW-12)/7);
  ctx.fillStyle=P.textDim;ctx.font='bold 7.5px monospace';ctx.fillText('DAILY EXECUTION %',M,chartY-4);
  ctx.fillStyle=P.border;ctx.fillRect(M,chartY,CW,1);
  weekDays.forEach((d,i)=>{
    const log=allLogs.find(l=>l.date===dateStr(d));
    const exec=log?.execPct||0;
    const bh=Math.round((exec/100)*(chartH-14));
    const bx=M+i*(barW+2);const by=chartY+chartH-bh;
    const col=exec>=85?P.accent:exec>=60?'#ffaa00':exec>0?'#ff6644':'#333333';
    ctx.fillStyle=col;ctx.fillRect(bx,by,barW,bh);
    ctx.fillStyle=P.textDim;ctx.font='6.5px monospace';ctx.textAlign='center';
    ctx.fillText(['Su','Mo','Tu','We','Th','Fr','Sa'][d.getDay()],bx+barW/2,chartY+chartH+10);
    if(exec>0){ctx.fillStyle=P.textDim;ctx.font='6px monospace';ctx.fillText(exec+'%',bx+barW/2,Math.max(by-2,chartY+4));}
    ctx.textAlign='left';
  });

  // 8×9 HEATMAP MATRIX
  const matrixY=chartY+chartH+24;
  const md = buildMatrixData(weekDays, allBlocks);
  // Find max for dynamic color scaling
  let matrixMax=0;
  SUBJECT_MATRIX_LABELS.forEach(s=>weekDays.forEach(d=>{const v=md[s]?.[dateStr(d)]?.hours||0;if(v>matrixMax)matrixMax=v;}));

  const col0W=68;const slotW=Math.floor((CW-col0W)/8);const matRowH=Math.floor((PDF_H-matrixY-60)/8);
  const darkMode=pdfTheme==='dark';

  ctx.fillStyle=P.textDim;ctx.font='bold 7.5px monospace';ctx.fillText('8×9 SUBJECT PERFORMANCE HEATMAP MATRIX — intensity = study hours',M,matrixY-4);

  for(let r=0;r<8;r++){
    for(let c=0;c<9;c++){
      const rx=M+(c===0?0:col0W+(c-1)*slotW);
      const ry=matrixY+r*matRowH;
      const rw=c===0?col0W:slotW;
      const rh=matRowH;
      const isHeader=(r===0);
      const isDayCol=(c===0);
      const subj=c>0?SUBJECT_MATRIX_LABELS[c-1]:null;
      const dayD=r>0?weekDays[r-1]:null;

      // Cell background
      let bgColor=P.surface;
      let textCol=P.text;
      if(isHeader||isDayCol){
        bgColor=P.tableHead;textCol=darkMode?P.accent:'#ffffff';
      } else if(subj&&dayD){
        const h=md[subj]?.[dateStr(dayD)]?.hours||0;
        if(matrixMax>0&&h>0){
          const ratio=h/matrixMax;
          // Dynamic heatmap: light mode = blue shades; dark = cyan/teal shades
          const base=darkMode?`rgba(0,221,204,`:`rgba(37,99,235,`;
          const alpha=Math.max(0.04,Math.min(0.85,ratio*0.85+0.04));
          bgColor=base+alpha+')';
          // Text readability: dark text for light high-intensity, white for dark high-intensity
          textCol=ratio>0.6?(darkMode?'#000000':'#ffffff'):P.text;
        } else bgColor=P.tableBg;
      }

      ctx.fillStyle=bgColor;ctx.fillRect(rx,ry,rw,rh);
      ctx.strokeStyle=isHeader||isDayCol?P.border2:P.border;ctx.lineWidth=isHeader||isDayCol?1.5:0.5;ctx.strokeRect(rx,ry,rw,rh);

      // Cell content
      ctx.fillStyle=textCol;ctx.textAlign='center';
      if(isHeader&&isDayCol){
        ctx.fillStyle=P.textLight;ctx.font='6px monospace';ctx.fillText('DAY↓ / SUBJ→',rx+rw/2,ry+rh/2);
      } else if(isHeader&&subj){
        ctx.font='bold 7.5px monospace';ctx.fillStyle=textCol;ctx.fillText(subj,rx+rw/2,ry+rh*0.55);
      } else if(isDayCol&&dayD){
        ctx.font='bold 8px monospace';ctx.fillText(['Su','Mo','Tu','We','Th','Fr','Sa'][dayD.getDay()],rx+rw/2,ry+14);
        ctx.font='6.5px monospace';ctx.fillStyle=P.textDim;ctx.fillText(fmtDateShort(dayD),rx+rw/2,ry+26);
      } else if(subj&&dayD){
        const cell=md[subj]?.[dateStr(dayD)]||{hours:0,tests:0};
        const disp=cell.hours>0?`${cell.hours.toFixed(1)}h`:'-';
        const dispt=cell.tests>0?`${cell.tests}T`:'';
        ctx.font='bold 7.5px monospace';ctx.fillStyle=textCol;ctx.fillText(disp,rx+rw/2,ry+rh*0.45);
        if(dispt){ctx.font='6.5px monospace';ctx.fillText(dispt,rx+rw/2,ry+rh*0.72);}
      }
      ctx.textAlign='left';
    }
  }
  ctx.strokeStyle=P.border2;ctx.lineWidth=2;ctx.strokeRect(M,matrixY,CW,8*matRowH);

  // Legend
  const legY=matrixY+8*matRowH+8;
  ctx.fillStyle=P.textLight;ctx.font='7px monospace';ctx.fillText('HEATMAP: darker cell = more hours. Each cell shows actual hours + tests for that subject on that day.',M,legY);

  drawPageFooter(ctx,P,`WEEK OF ${fmtDateShort(firstDate).toUpperCase()} – ${fmtDateShort(lastDate).toUpperCase()}`);
  return canvasToJpeg(canvas,0.92);
}

// --- Full Analytical PDF (comprehensive multi-page) ---
async function exportFullAnalyticalPDF() {
  const prog=el('jrnlProgress'),progTxt=el('jrnlProgressText');
  if(prog) prog.classList.add('active');
  const btnList=[el('jrnlGenerateBtn'),document.querySelector('[onclick="exportFullAnalyticalPDF()"]')];
  btnList.forEach(b=>{if(b)b.disabled=true;});

  try {
    const allBlocks=await dbGetAll('studyBlocks');
    const allLogs=await dbGetAll('dailyLogs');
    const allInts=await dbGetAll('interruptions');
    const allFatigue=await dbGetAll('fatigueHistory');
    const mission=state.mission;
    const pdfTheme=journalState.pdfTheme;
    const P=getJournalPalette(pdfTheme);
    const pages=[];

    // Use last 7 days for heatmap
    const last7=Array.from({length:7},(_,i)=>addDays(new Date(),-6+i));
    const matrixData=buildMatrixData(last7,allBlocks);

    // Page 1: Cover + weekly summary stats + execution trend chart
    if(progTxt) progTxt.textContent='Rendering analytical cover…';
    await new Promise(r=>setTimeout(r,10));
    const pg1=await renderAnalyticalCoverPage(allLogs,allBlocks,allInts,allFatigue,mission,last7,matrixData,pdfTheme,P);
    pages.push(pg1);

    // Page 2: Subject analytics + heatmap
    if(progTxt) progTxt.textContent='Rendering subject & heatmap page…';
    await new Promise(r=>setTimeout(r,10));
    const subjectAnalytics=computeSubjectAnalytics(allBlocks);
    const pg2=await renderAnalyticalSubjectPage(allBlocks,last7,matrixData,subjectAnalytics,pdfTheme,P);
    pages.push(pg2);

    // Page 3: Full advisory narrative
    if(progTxt) progTxt.textContent='Rendering full advisory narrative…';
    await new Promise(r=>setTimeout(r,10));
    const s=dateStr(addDays(new Date(),-30)),e=today();
    const rangeLogs=allLogs.filter(l=>l.date>=s&&l.date<=e);
    if(rangeLogs.length>0){
      const rm=computeRangeMetrics(rangeLogs,allBlocks,allInts,allFatigue,s,e);
      const prevStart=dateStr(addDays(parseDate(s),-31)),prevEnd=dateStr(addDays(parseDate(s),-1));
      const pm=computeRangeMetrics(allLogs.filter(l=>l.date>=prevStart&&l.date<=prevEnd),allBlocks,allInts,allFatigue,prevStart,prevEnd);
      const lm=computeRangeMetrics(allLogs,allBlocks,allInts,allFatigue,'','');
      const narr=buildHumanReport(rm,pm,null,lm,s,e,30,subjectAnalytics,last7,matrixData);
      const pg3=await renderAnalyticalNarrativePage(narr,pdfTheme,P);
      pages.push(pg3);
    }

    const pdf=buildPDFFromJpegs(pages,595.28,841.89);
    downloadPDF(pdf,`execution-analytical-report-${today()}.pdf`);
  } catch(err){showToast('Analytical PDF error: '+err.message);console.error(err);}

  if(prog) prog.classList.remove('active');
  btnList.forEach(b=>{if(b)b.disabled=false;});
}

async function renderAnalyticalCoverPage(allLogs,allBlocks,allInts,allFatigue,mission,last7,matrixData,pdfTheme,P){
  const canvas=makeCanvas(PDF_W,PDF_H);const ctx=canvas.getContext('2d');
  ctx.fillStyle=P.bg;ctx.fillRect(0,0,PDF_W,PDF_H);
  drawPageHeader(ctx,P,'FULL ANALYTICAL REPORT','COMPREHENSIVE PERFORMANCE ANALYSIS',1,3);

  // Summary metrics box
  const logs30=allLogs.slice(-30);
  const totH=logs30.reduce((s,l)=>s+(l.completedSec||0)/3600,0);
  const totT=logs30.reduce((s,l)=>s+(l.totalTests||0),0);
  const avgExec=logs30.length?Math.round(logs30.reduce((s,l)=>s+(l.execPct||0),0)/logs30.length):0;
  const eff=totH>0?totT/totH:0;

  const sw=Math.floor((CW-36)/4);
  [{label:'30-DAY HOURS',value:totH.toFixed(1)+'h'},{label:'30-DAY TESTS',value:String(totT)},{label:'AVG EXECUTION',value:avgExec+'%'},{label:'TEST EFF/HR',value:eff.toFixed(1)}]
    .forEach((s,i)=>drawStatBox(ctx,P,M+i*(sw+12),104,sw,68,s.label,s.value,4));

  // Execution trend chart (last 30 days)
  const chartY=186,chartH=120;
  ctx.fillStyle=P.textDim;ctx.font='bold 8px monospace';ctx.fillText('EXECUTION % TREND — LAST 30 DAYS',M,chartY-6);
  ctx.fillStyle=P.border;ctx.fillRect(M,chartY,CW,1);
  const data30=logs30.map(l=>l.execPct||0);
  if(data30.length>1){
    const stepX=(CW-8)/(data30.length-1);
    ctx.beginPath();
    data30.forEach((v,i)=>{const x=M+4+i*stepX;const y=chartY+chartH-(v/100)*(chartH-10);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});
    ctx.strokeStyle=P.accent;ctx.lineWidth=2;ctx.stroke();
    // Fill
    ctx.lineTo(M+4+(data30.length-1)*stepX,chartY+chartH);ctx.lineTo(M+4,chartY+chartH);ctx.closePath();
    ctx.fillStyle=(pdfTheme==='dark')?'rgba(0,255,136,0.08)':'rgba(26,94,56,0.08)';ctx.fill();
    // Dots
    data30.forEach((v,i)=>{const x=M+4+i*stepX;const y=chartY+chartH-(v/100)*(chartH-10);ctx.beginPath();ctx.arc(x,y,2,0,Math.PI*2);ctx.fillStyle=P.accent;ctx.fill();});
  }
  // 80% threshold line
  const thresh80=chartY+chartH-(0.8)*(chartH-10);
  ctx.strokeStyle='rgba(255,59,59,0.4)';ctx.lineWidth=0.5;ctx.setLineDash([4,4]);
  ctx.beginPath();ctx.moveTo(M,thresh80);ctx.lineTo(M+CW,thresh80);ctx.stroke();ctx.setLineDash([]);
  ctx.fillStyle='rgba(255,59,59,0.7)';ctx.font='7px monospace';ctx.textAlign='right';ctx.fillText('80% THRESHOLD',M+CW,thresh80-2);ctx.textAlign='left';

  // Fatigue trend (last 14 days)
  const fat14=allFatigue.slice(-14);
  const chartY2=chartY+chartH+28;const chartH2=80;
  ctx.fillStyle=P.textDim;ctx.font='bold 8px monospace';ctx.fillText('FATIGUE INDEX TREND — LAST 14 DAYS',M,chartY2-6);
  ctx.fillStyle=P.border;ctx.fillRect(M,chartY2,CW,1);
  if(fat14.length>1){
    const sx2=(CW-8)/(fat14.length-1);
    ctx.beginPath();
    fat14.forEach((f,i)=>{const x=M+4+i*sx2;const y=chartY2+chartH2-(f.fatigue/100)*(chartH2-6);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});
    ctx.strokeStyle=pdfTheme==='dark'?'#ffaa00':'#d97706';ctx.lineWidth=1.5;ctx.stroke();
  }

  // Interruption heatmap bar
  const intY=chartY2+chartH2+20;
  const hours=allInts.reduce((m,i)=>{const h=new Date(i.timestamp).getHours();m[h]=(m[h]||0)+1;return m;},{});
  const maxInt=Math.max(...Object.values(hours),1);
  ctx.fillStyle=P.textDim;ctx.font='bold 8px monospace';ctx.fillText('INTERRUPTION FREQUENCY BY HOUR',M,intY-6);
  const iBarW=Math.floor(CW/24);
  for(let h=0;h<24;h++){
    const count=hours[h]||0;const bh=Math.round((count/maxInt)*30);
    ctx.fillStyle=count>0?'rgba(255,59,59,'+(0.2+0.7*(count/maxInt))+')':'rgba(100,100,100,0.1)';
    ctx.fillRect(M+h*iBarW,intY+30-bh,iBarW-1,bh);
    if(h%4===0){ctx.fillStyle=P.textDim;ctx.font='6.5px monospace';ctx.textAlign='center';ctx.fillText(pad2(h),M+h*iBarW+iBarW/2,intY+42);}
    ctx.textAlign='left';
  }

  // Mission pressure gauge
  if(mission){
    const mpY=intY+55;
    const dL=Math.max(1,Math.ceil((new Date(mission.targetDate)-new Date())/86400000));
    const compH=allLogs.reduce((s,l)=>s+(l.completedSec||0)/3600,0);
    const remH=Math.max(0,mission.requiredHours-compH);
    const cap=logs30.length>0?logs30.reduce((s,l)=>s+(l.completedSec||0)/3600,0)/logs30.length:3;
    const tpi=dL>0?remH/(dL*cap):99;
    ctx.fillStyle=P.surface;ctx.fillRect(M,mpY,CW,60);ctx.strokeStyle=P.border;ctx.lineWidth=1;ctx.strokeRect(M,mpY,CW,60);
    ctx.fillStyle=P.textDim;ctx.font='bold 8px monospace';ctx.fillText('MISSION PRESSURE ENGINE',M+10,mpY+14);
    const tpiCol=tpi>1.2?'#ff3b3b':tpi>1.0?'#ff7700':tpi>0.8?'#ffaa00':'#00ff88';
    ctx.fillStyle=tpiCol;ctx.font='bold 22px monospace';ctx.fillText('TPI '+tpi.toFixed(2),M+10,mpY+42);
    ctx.fillStyle=P.text;ctx.font='9px monospace';ctx.textAlign='right';ctx.fillText(`${mission.name||'Mission'} · ${dL}d remaining · ${remH.toFixed(0)}h outstanding · Daily cap ${cap.toFixed(1)}h`,M+CW-10,mpY+42);ctx.textAlign='left';
  }

  drawPageFooter(ctx,P,'EXECUTION ENGINE · FULL ANALYTICAL REPORT · PAGE 1 OF 3');
  return canvasToJpeg(canvas,0.92);
}

async function renderAnalyticalSubjectPage(allBlocks,last7,matrixData,subjectAnalytics,pdfTheme,P){
  const canvas=makeCanvas(PDF_W,PDF_H);const ctx=canvas.getContext('2d');
  ctx.fillStyle=P.bg;ctx.fillRect(0,0,PDF_W,PDF_H);
  drawPageHeader(ctx,P,'SUBJECT INTELLIGENCE & HEATMAP','SUBJECT × DAY PERFORMANCE MATRIX',2,3);

  // Subject cards
  const sa=subjectAnalytics;
  const cardH=64,cardGap=8,cardW=Math.floor((CW-cardGap*(Math.min(sa.subjects.length,4)-1))/Math.min(sa.subjects.length,4));
  let cardy=104;
  ctx.fillStyle=P.textDim;ctx.font='bold 8px monospace';ctx.fillText('SUBJECT DISTRIBUTION ANALYTICS',M,cardy-6);

  sa.subjects.slice(0,8).forEach((s,i)=>{
    const row=Math.floor(i/4),col=i%4;
    const cx=M+col*(cardW+cardGap),cy=cardy+row*(cardH+cardGap);
    ctx.fillStyle=P.surface;ctx.fillRect(cx,cy,cardW,cardH);
    ctx.strokeStyle=P.border;ctx.lineWidth=1;ctx.strokeRect(cx,cy,cardW,cardH);
    const col2=subjectCatColor(s.name);
    ctx.fillStyle=col2;ctx.fillRect(cx,cy,3,cardH);ctx.fillRect(cx,cy,cardW,3);
    ctx.fillStyle=P.text;ctx.font='bold 9px monospace';ctx.fillText(truncStr(s.name,cardW-14,ctx),cx+8,cy+16);
    ctx.fillStyle=P.textDim;ctx.font='7px monospace';
    ctx.fillText(`${s.hours.toFixed(1)}h`,cx+8,cy+30);ctx.fillText(`${s.tests}T`,cx+8,cy+40);
    ctx.fillText(`${s.efficiency.toFixed(1)}/hr`,cx+8,cy+50);
    ctx.textAlign='right';ctx.fillStyle=col2;ctx.font='bold 11px monospace';ctx.fillText(s.dominance.toFixed(0)+'%',cx+cardW-6,cy+26);ctx.textAlign='left';
    // Dominance mini bar
    ctx.fillStyle=P.border;ctx.fillRect(cx+4,cy+cardH-8,cardW-8,4);
    ctx.fillStyle=col2;ctx.fillRect(cx+4,cy+cardH-8,Math.round((s.dominance/100)*(cardW-8)),4);
  });

  // Neglected subjects
  const neglectedY=cardy+(Math.ceil(Math.min(sa.subjects.length,8)/4))*(cardH+cardGap)+10;
  if(sa.neglected.length>0){
    ctx.fillStyle='rgba(255,59,59,0.1)';ctx.fillRect(M,neglectedY,CW,28);
    ctx.strokeStyle='rgba(255,59,59,0.3)';ctx.lineWidth=1;ctx.strokeRect(M,neglectedY,CW,28);
    ctx.fillStyle='#ff3b3b';ctx.font='bold 8px monospace';ctx.fillText('NEGLECTED / ABSENT SUBJECTS: '+sa.neglected.join(' · '),M+10,neglectedY+18);
  }

  // 8×9 heatmap matrix
  const matY=neglectedY+40;
  let matrixMax=0;
  SUBJECT_MATRIX_LABELS.forEach(s=>last7.forEach(d=>{const v=matrixData[s]?.[dateStr(d)]?.hours||0;if(v>matrixMax)matrixMax=v;}));
  const col0W=70,slotW=Math.floor((CW-col0W)/8),matRowH=Math.floor((PDF_H-matY-80)/8);
  const darkMode=pdfTheme==='dark';

  ctx.fillStyle=P.textDim;ctx.font='bold 8px monospace';ctx.fillText('8×9 SUBJECT × DAY HEATMAP MATRIX — Last 7 Days',M,matY-6);

  for(let r=0;r<8;r++){
    for(let c=0;c<9;c++){
      const rx=M+(c===0?0:col0W+(c-1)*slotW);
      const ry=matY+r*matRowH;
      const rw=c===0?col0W:slotW;const rh=matRowH;
      const isH=(r===0),isD=(c===0);
      const subj=c>0?SUBJECT_MATRIX_LABELS[c-1]:null;
      const dayD=r>0?last7[r-1]:null;
      let bg=P.surface,tc=P.text;
      if(isH||isD){bg=P.tableHead;tc=darkMode?P.accent:'#ffffff';}
      else if(subj&&dayD){
        const h=matrixData[subj]?.[dateStr(dayD)]?.hours||0;
        if(matrixMax>0&&h>0){
          const ratio=h/matrixMax;const alpha=Math.max(0.06,Math.min(0.88,ratio*0.88+0.06));
          bg=(darkMode?`rgba(0,221,204,`:`rgba(37,99,235,`)+alpha+')';
          tc=ratio>0.6?(darkMode?'#000000':'#ffffff'):P.text;
        }else bg=P.tableBg;
      }
      ctx.fillStyle=bg;ctx.fillRect(rx,ry,rw,rh);
      ctx.strokeStyle=isH||isD?P.border2:P.border;ctx.lineWidth=isH||isD?1.5:0.5;ctx.strokeRect(rx,ry,rw,rh);
      ctx.fillStyle=tc;ctx.textAlign='center';
      if(isH&&isD){ctx.fillStyle=P.textLight;ctx.font='5.5px monospace';ctx.fillText('DAY / SUBJ',rx+rw/2,ry+rh/2);}
      else if(isH&&subj){ctx.font='bold 7px monospace';ctx.fillText(subj,rx+rw/2,ry+rh*0.58);}
      else if(isD&&dayD){ctx.font='bold 7.5px monospace';ctx.fillText(['Su','Mo','Tu','We','Th','Fr','Sa'][dayD.getDay()],rx+rw/2,ry+12);ctx.font='6px monospace';ctx.fillStyle=P.textDim;ctx.fillText(fmtDateShort(dayD),rx+rw/2,ry+22);}
      else if(subj&&dayD){
        const cell=matrixData[subj]?.[dateStr(dayD)]||{hours:0,tests:0};
        ctx.font='bold 7px monospace';ctx.fillStyle=tc;ctx.fillText(cell.hours>0?cell.hours.toFixed(1)+'h':'-',rx+rw/2,ry+rh*0.45);
        if(cell.tests>0){ctx.font='6px monospace';ctx.fillText(cell.tests+'T',rx+rw/2,ry+rh*0.72);}
      }
      ctx.textAlign='left';
    }
  }
  ctx.strokeStyle=P.border2;ctx.lineWidth=2;ctx.strokeRect(M,matY,CW,8*matRowH);

  // Heatmap pattern analysis text
  const patY=matY+8*matRowH+10;
  let emptyDays=0,spikeDays=[];
  last7.forEach(d=>{const ds=dateStr(d);const dt=SUBJECT_MATRIX_LABELS.reduce((s,sub)=>s+(matrixData[sub]?.[ds]?.hours||0),0);if(dt===0)emptyDays++;if(dt>8)spikeDays.push(fmtDateShort(d));});
  const patLines=[];
  if(emptyDays>0) patLines.push(`Empty days detected: ${emptyDays} days with no logged activity. Schedule recovery sessions.`);
  if(spikeDays.length) patLines.push(`Volume spikes: ${spikeDays.join(', ')} exceeded 8h. Distribute workload to maximize retention.`);
  if(patLines.length===0) patLines.push('Heatmap pattern: no critical clustering or empty-day anomalies detected this week.');
  ctx.fillStyle=P.textDim;ctx.font='7.5px monospace';
  patLines.forEach((line,i)=>ctx.fillText(line,M,patY+12+i*14));

  drawPageFooter(ctx,P,'EXECUTION ENGINE · FULL ANALYTICAL REPORT · PAGE 2 OF 3');
  return canvasToJpeg(canvas,0.92);
}

async function renderAnalyticalNarrativePage(humanReportHTML,pdfTheme,P){
  const canvas=makeCanvas(PDF_W,PDF_H);const ctx=canvas.getContext('2d');
  ctx.fillStyle=P.bg;ctx.fillRect(0,0,PDF_W,PDF_H);
  drawPageHeader(ctx,P,'ADVISOR FULL NARRATIVE','30-DAY HUMAN-STYLE ADVISORY ASSESSMENT',3,3);

  // Strip HTML tags for canvas text rendering
  const stripHTML=(html)=>html.replace(/<[^>]+>/g,'').replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>');
  const sections=humanReportHTML.match(/<div class="report-paragraph[^>]*>[\s\S]*?<\/div>/g)||[];
  let ty=108;
  const lineH=14,maxLineW=CW-20;

  sections.forEach(section=>{
    const tagMatch=section.match(/report-paragraph-tag">([^<]+)/);
    const tag=tagMatch?tagMatch[1]:'';
    const textMatch=section.match(/<\/span>([\s\S]+)<\/div>/);
    const rawText=textMatch?stripHTML(textMatch[1]).trim():'';

    if(!rawText||ty>PDF_H-100) return;

    // Section tag
    ctx.fillStyle=P.accent;ctx.font='bold 8px monospace';ctx.fillText(tag,M,ty);ty+=12;
    ctx.fillStyle=P.border;ctx.fillRect(M,ty,CW,0.5);ty+=8;

    // Word-wrapped text
    ctx.fillStyle=P.text;ctx.font='9px sans-serif';
    const words=rawText.split(' ');let line='';
    words.forEach(word=>{
      const test=line+word+' ';
      if(ctx.measureText(test).width>maxLineW&&line!==''){
        ctx.fillText(line.trim(),M,ty);ty+=lineH;line=word+' ';
        if(ty>PDF_H-80){ty=PDF_H-80;return;}
      } else line=test;
    });
    if(line.trim()) {ctx.fillText(line.trim(),M,ty);ty+=lineH;}
    ty+=10;
  });

  drawPageFooter(ctx,P,'EXECUTION ENGINE · FULL ANALYTICAL REPORT · PAGE 3 OF 3');
  return canvasToJpeg(canvas,0.92);
}

// --- Main operational PDF trigger ---
async function triggerJournalGenerate() {
  const prog=el('jrnlProgress'),progTxt=el('jrnlProgressText');
  if(prog) prog.classList.add('active');
  const btn=el('jrnlGenerateBtn');if(btn)btn.disabled=true;
  await new Promise(r=>setTimeout(r,0));
  try {
    const allBlocks=state.blocks;
    const allLogs=await dbGetAll('dailyLogs');
    const mission=state.mission;
    const pages=[];
    if(journalState.mode==='day'){
      if(progTxt)progTxt.textContent='Rendering day page…';
      await new Promise(r=>setTimeout(r,10));
      const ds=journalState.dayDate;
      const blocks=allBlocks.filter(b=>b.date===ds);
      const log=allLogs.find(l=>l.date===ds)||null;
      const jpeg=await renderDayPageToJpeg(parseDate(ds),blocks,log,mission,state.fatigueIndex,journalState.pdfTheme);
      pages.push(jpeg);
      const pdf=buildPDFFromJpegs(pages,595.28,841.89);
      downloadPDF(pdf,`execution-journal-${ds}.pdf`);
    } else {
      if(progTxt)progTxt.textContent='Rendering weekly operational page…';
      await new Promise(r=>setTimeout(r,10));
      const days=getWeekDays(journalState.weekRefDate,journalState.weekStartDay);
      const jpeg=await renderWeeklyOpsPageToJpeg(days,allBlocks,allLogs,mission,journalState.pdfTheme);
      pages.push(jpeg);
      const pdf=buildPDFFromJpegs(pages,595.28,841.89);
      downloadPDF(pdf,`execution-weekly-journal-${dateStr(days[0])}.pdf`);
    }
  } catch(err){showToast('PDF error: '+err.message);console.error(err);}
  if(prog)prog.classList.remove('active');
  if(btn)btn.disabled=false;
}

// Shortcut triggers from Report view
function exportOperationalDayPDF() {
  journalState.dayDate=today();journalState.mode='day';
  const b=el('jrnlGenerateBtn');if(b){journalState.pdfTheme='light';triggerJournalGenerate();}
  else{switchView('journal',null);setTimeout(()=>{setJournalMode('day');triggerJournalGenerate();},200);}
}
function exportOperationalWeekPDF() {
  journalState.weekRefDate=today();journalState.mode='week';journalState.weekStartDay=1;
  triggerJournalGenerate();
}

// ================================================================
// MINIMAL OFFLINE PDF ENCODER
// Builds a valid PDF 1.4 binary with JPEG images as pages
// No external libraries — pure JavaScript
// ================================================================
function buildPDFFromJpegs(jpegDataUrls, pageWidthPt, pageHeightPt) {
  const enc = new TextEncoder();
  const parts = [];
  let pos = 0;
  const offsets = {};

  function pushStr(s) {
    const b = enc.encode(s);
    parts.push(b);
    pos += b.length;
  }
  function pushBytes(b) {
    parts.push(b);
    pos += b.length;
  }
  function mark(n) { offsets[n] = pos; }

  function b64ToBytes(b64url) {
    const b64 = b64url.includes(',') ? b64url.split(',')[1] : b64url;
    const bin = atob(b64);
    const out = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i);
    return out;
  }

  function jpegDims(bytes) {
    for (let i = 0; i < bytes.length - 9; i++) {
      if (bytes[i] === 0xFF && (bytes[i+1] === 0xC0 || bytes[i+1] === 0xC1 || bytes[i+1] === 0xC2)) {
        return { h: (bytes[i+5] << 8) | bytes[i+6], w: (bytes[i+7] << 8) | bytes[i+8] };
      }
    }
    return { w: PDF_W, h: PDF_H };
  }

  const N     = jpegDataUrls.length;
  const jpegs = jpegDataUrls.map(b64ToBytes);
  const dims  = jpegs.map(jpegDims);

  // Object layout:
  // 1 = Catalog, 2 = Pages
  // Page i (0-indexed): obj 3+i*3 (Page dict), 4+i*3 (Contents stream), 5+i*3 (Image XObject)

  // PDF header
  pushStr('%PDF-1.4\n');

  // Obj 1: Catalog
  mark(1);
  pushStr(`1 0 obj\n<</Type /Catalog /Pages 2 0 R>>\nendobj\n`);

  // Obj 2: Pages
  mark(2);
  const kids = Array.from({length: N}, (_, i) => `${3 + i*3} 0 R`).join(' ');
  const Wstr = pageWidthPt.toFixed(2), Hstr = pageHeightPt.toFixed(2);
  pushStr(`2 0 obj\n<</Type /Pages /Kids [${kids}] /Count ${N}>>\nendobj\n`);

  // Each page
  for (let i = 0; i < N; i++) {
    const pn = 3 + i*3;
    const cn = 4 + i*3;
    const xn = 5 + i*3;
    const {w, h} = dims[i];

    mark(pn);
    pushStr(`${pn} 0 obj\n<</Type /Page /Parent 2 0 R /MediaBox [0 0 ${Wstr} ${Hstr}] /Contents ${cn} 0 R /Resources <</XObject <</Im${i} ${xn} 0 R>>>>>>\nendobj\n`);

    // Content stream: scale image to fill entire page
    const cs = `q\n${Wstr} 0 0 ${Hstr} 0 0 cm\n/Im${i} Do\nQ\n`;
    mark(cn);
    pushStr(`${cn} 0 obj\n<</Length ${cs.length}>>\nstream\n${cs}\nendstream\nendobj\n`);

    // Image XObject
    mark(xn);
    pushStr(`${xn} 0 obj\n<</Type /XObject /Subtype /Image /Width ${w} /Height ${h} /ColorSpace /DeviceRGB /BitsPerComponent 8 /Filter /DCTDecode /Length ${jpegs[i].length}>>\nstream\n`);
    pushBytes(jpegs[i]);
    pushStr(`\nendstream\nendobj\n`);
  }

  // Cross-reference table
  const xrefPos  = pos;
  const maxObjNum = 2 + N * 3;
  pushStr(`xref\n0 ${maxObjNum + 1}\n`);
  pushStr(`0000000000 65535 f \n`);
  for (let n = 1; n <= maxObjNum; n++) {
    const off = offsets[n] !== undefined ? offsets[n] : 0;
    pushStr(`${String(off).padStart(10, '0')} 00000 n \n`);
  }

  // Trailer
  pushStr(`trailer\n<</Size ${maxObjNum + 1} /Root 1 0 R>>\nstartxref\n${xrefPos}\n%%EOF\n`);

  // Assemble into single Uint8Array
  let total = 0;
  parts.forEach(p => total += p.length);
  const result = new Uint8Array(total);
  let cursor = 0;
  parts.forEach(p => { result.set(p, cursor); cursor += p.length; });
  return result;
}

function downloadPDF(pdfBytes, filename) {
  const blob = new Blob([pdfBytes], { type: 'application/pdf' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
  showToast(`Saved: ${filename}`);
}

// ================================================================
// END JOURNAL PDF ENGINE
// ================================================================
async function boot() {
  await initDB();
  await loadMetrics();      // initializes to 50 if no stored values
  await loadBlocks();
  await loadHabits();
  await loadTodayLog();
  await loadMission();
  await loadTheme();
  await checkBackupReminder();
  // Recover any sessions that were "running" before page close
  state.blocks.filter(b=>b.status==='running').forEach(b=>{b.status='paused';dbPut('studyBlocks',b);});
  await renderDashboard();
  renderBlocks();
  renderHabits();
  setInterval(renderDashboard,30000);
}
boot();
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('PWA Service Worker Registered'))
        .catch(err => console.log('PWA Service Worker registration failed', err));
    });
  }
</script>

</body>
</html>
